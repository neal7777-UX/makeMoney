<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼‘é–’é¢¨å€‹äººè¨˜å¸³æœ¬ (æœ¬åœ°ç‰ˆ)</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 50%, #80cbc4 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #78a1a1 0%, #5a8585 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(120, 161, 161, 0.4);
        }

        .input-field {
            transition: all 0.3s ease;
            max-width: 100%;
        }

        .input-field:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(120, 161, 161, 0.2);
        }

        .scroll-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #78a1a1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #5a8585;
        }
        
        /* ä¿®å¤æ‰‹æœºä¸Šçš„æ—¥æœŸè¾“å…¥æ¡†æº¢å‡º */
        input[type="date"],
        input[type="month"] {
            min-width: 0;
            flex-shrink: 1;
        }
        
        /* ç¡®ä¿æ‰€æœ‰å†…å®¹ä¸ä¼šæº¢å‡º */
        .glass-card {
            max-width: 100%;
            overflow: hidden;
        }
        
        /* å¼ºåˆ¶æ‰€æœ‰å…ƒç´ ä¸æº¢å‡º */
        input, select, textarea, button {
            max-width: 100%;
        }
        
        /* æ ‡é¢˜å“åº”å¼ */
        h1 {
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* ä¸»å®¹å™¨ä¸æº¢å‡º */
        #main-content {
            max-width: 100%;
            overflow-x: hidden;
        }
    </style>
</head>
<body class="p-3 sm:p-4 md:p-8">
    <!-- é€šçŸ¥çµ„ä»¶ -->
    <div id="notification" class="hidden fixed top-4 right-4 px-6 py-3 rounded-2xl shadow-lg z-50">
        <p id="notification-message" class="font-medium"></p>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div id="main-content" class="max-w-7xl mx-auto">
        <!-- æ¨™é¡Œ -->
        <header class="text-center mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl md:text-5xl font-bold text-teal-800 mb-2">ğŸ’° ä¼‘é–’é¢¨å€‹äººè¨˜å¸³æœ¬</h1>
            <p class="text-sm sm:text-base text-teal-600">è¼•é¬†ç®¡ç†æ‚¨çš„è²¡å‹™ï¼Œè¿½è¹¤æ¯ä¸€ç­†æ”¯å‡º</p>
            <p class="text-xs sm:text-sm text-teal-500 mt-2">ğŸ“± æœ¬åœ°ç‰ˆæœ¬</p>
        </header>

        <!-- éŸ¿æ‡‰å¼ä½ˆå±€ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- å·¦å´ï¼šè³‡ç”¢ç¸½è¦½èˆ‡æœˆåº¦ç¸½è¦½ -->
            <div class="space-y-6">
                <!-- ç¸½è³‡ç”¢å¡ç‰‡ -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <div class="flex items-start justify-between mb-4">
                        <h2 class="text-xl font-bold text-teal-800 flex items-center gap-2">
                            <span>ğŸ’</span>
                            <span>ç¸½è³‡ç”¢</span>
                        </h2>
                        <!-- ç¼–è¾‘æŒ‰é’® -->
                        <button 
                            id="edit-assets-btn"
                            onclick="toggleEditAssets()"
                            class="px-3 py-1 text-sm bg-teal-500 hover:bg-teal-600 text-white rounded-lg transition-colors"
                        >
                            âœï¸ ç·¨è¼¯
                        </button>
                        <!-- ç¼–è¾‘åŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰ -->
                        <div id="edit-assets-section" class="hidden flex items-center gap-2">
                            <input 
                                type="number" 
                                id="assets-input" 
                                placeholder="é‡‘é¡"
                                class="input-field w-20 sm:w-24 px-2 py-1 text-sm rounded-lg border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            >
                            <button 
                                onclick="updateTotalAssets()"
                                class="px-2 sm:px-3 py-1 text-sm bg-teal-500 hover:bg-teal-600 text-white rounded-lg transition-colors whitespace-nowrap"
                                title="è¦†è“‹è¨­å®šç¸½è³‡ç”¢"
                            >
                                è¨­å®š
                            </button>
                            <button 
                                onclick="toggleEditAssets()"
                                class="px-2 sm:px-3 py-1 text-sm bg-gray-400 hover:bg-gray-500 text-white rounded-lg transition-colors"
                                title="å–æ¶ˆ"
                            >
                                âœ•
                            </button>
                        </div>
                    </div>
                    <div class="text-center mb-6">
                        <p class="text-3xl sm:text-4xl font-bold text-teal-700" id="total-assets">$0</p>
                    </div>
                    <div class="space-y-3">
                        <input 
                            type="number" 
                            id="add-assets-input" 
                            placeholder="è¼¸å…¥è¦æ–°å¢çš„é‡‘é¡"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                        >
                        <button 
                            onclick="addToTotalAssets()"
                            class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                        >
                            æ–°å¢è³‡ç”¢
                        </button>
                    </div>
                </div>

                <!-- æœ¬æœˆæ”¯å‡ºé è¦½ -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>ğŸ“Š</span>
                        <span>æœ¬æœˆæ”¯å‡ºé è¦½</span>
                    </h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">ä¸€èˆ¬æ”¯å‡º</span>
                            <span class="font-bold text-red-500" id="monthly-expenses">$0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">åˆ†æœŸæ”¤æ</span>
                            <span class="font-bold text-purple-500" id="monthly-installments">$0</span>
                        </div>
                        <div class="border-t-2 border-teal-200 pt-3 flex justify-between items-center">
                            <span class="text-lg font-bold text-teal-800">æœ¬æœˆç¸½è¨ˆ</span>
                            <span class="text-2xl font-bold text-teal-700" id="monthly-total">$0</span>
                        </div>
                    </div>
                </div>

                <!-- æ”¯å‡ºé¡å‹çµ±è¨ˆ -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>ğŸ¥§</span>
                        <span>æ”¯å‡ºé¡å‹çµ±è¨ˆ</span>
                    </h2>
                    <div class="relative" style="height: 280px;">
                        <canvas id="expense-chart"></canvas>
                    </div>
                    <div id="chart-legend" class="mt-4 space-y-2">
                        <!-- åœ–ä¾‹å°‡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šæ“ä½œå€èˆ‡äº¤æ˜“ç´€éŒ„ -->
            <div class="space-y-6">
                <!-- æ“ä½œå€ï¼šæ–°å¢æ”¯å‡ºèˆ‡åˆ†æœŸ -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <!-- æ¨™ç±¤åˆ‡æ› -->
                    <div class="flex gap-2 mb-6">
                        <button 
                            id="tab-expense"
                            onclick="switchTab('expense')"
                            class="flex-1 py-3 px-4 rounded-2xl font-medium transition-all"
                        >
                            ğŸ“ æ–°å¢æ—¥å¸¸æ”¯å‡º
                        </button>
                        <button 
                            id="tab-installment"
                            onclick="switchTab('installment')"
                            class="flex-1 py-3 px-4 rounded-2xl font-medium transition-all"
                        >
                            ğŸ’³ æ–°å¢åˆ†æœŸè¨ˆç•«
                        </button>
                    </div>

                    <!-- æ–°å¢æ—¥å¸¸æ”¯å‡ºè¡¨å–® -->
                    <div id="form-expense" class="form-content">
                        <form class="space-y-4" onsubmit="event.preventDefault(); addExpense();">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label>
                                <input 
                                    type="date" 
                                    id="expense-date" 
                                    required
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é‡‘é¡</label>
                                <input 
                                    type="number" 
                                    id="expense-amount" 
                                    placeholder="è¼¸å…¥é‡‘é¡"
                                    required
                                    min="0"
                                    step="1"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é¡åˆ¥</label>
                                <select 
                                    id="expense-category"
                                    required
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                                    <option value="é¤é£²">ğŸ½ï¸ é¤é£²</option>
                                    <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                                    <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
                                    <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                                    <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æè¿°</label>
                                <input 
                                    type="text" 
                                    id="expense-description" 
                                    placeholder="é …ç›®æè¿°ï¼ˆé¸å¡«ï¼‰"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <button 
                                type="submit"
                                class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                            >
                                æ–°å¢æ”¯å‡º
                            </button>
                        </form>
                    </div>

                    <!-- æ–°å¢åˆ†æœŸè¨ˆç•«è¡¨å–® -->
                    <div id="form-installment" class="form-content hidden">
                        <form class="space-y-4" onsubmit="event.preventDefault(); addInstallment();">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ç¸½é¡</label>
                                <input 
                                    type="number" 
                                    id="installment-total" 
                                    placeholder="è¼¸å…¥ç¸½é‡‘é¡"
                                    min="0"
                                    step="1"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æœŸæ•¸</label>
                                <input 
                                    type="number" 
                                    id="installment-periods" 
                                    placeholder="åˆ†å¹¾æœŸ"
                                    min="1"
                                    step="1"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æœˆä»½</label>
                                <input 
                                    type="month" 
                                    id="installment-start" 
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none cursor-pointer"
                                    onclick="this.showPicker()"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é¡åˆ¥</label>
                                <select 
                                    id="installment-category"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                                    <option value="é¤é£²">ğŸ½ï¸ é¤é£²</option>
                                    <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                                    <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
                                    <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                                    <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æè¿°</label>
                                <input 
                                    type="text" 
                                    id="installment-description" 
                                    placeholder="é …ç›®æè¿°ï¼ˆé¸å¡«ï¼‰"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <button 
                                type="submit"
                                class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                            >
                                æ–°å¢åˆ†æœŸè¨ˆç•«
                            </button>
                        </form>
                    </div>
                </div>

                <!-- è¿‘æœŸäº¤æ˜“ç´€éŒ„ -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>ğŸ“œ</span>
                        <span>è¿‘æœŸäº¤æ˜“ç´€éŒ„</span>
                    </h2>
                    <div id="transaction-list" class="scroll-container space-y-3">
                        <!-- äº¤æ˜“ç´€éŒ„å°‡å‹•æ…‹è¼‰å…¥ -->
                        <div class="text-center text-gray-400 py-8">
                            <p>å°šç„¡äº¤æ˜“ç´€éŒ„</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é å°¾ -->
        <footer class="text-center mt-12 text-teal-600">
            <p class="text-sm">Â© 2025 ä¼‘é–’é¢¨å€‹äººè¨˜å¸³æœ¬ | è¼•é¬†ç®¡ç†ï¼Œç²¾å½©ç”Ÿæ´» âœ¨</p>
        </footer>
    </div>

    <script>
        // ============================================
        // å…¨åŸŸè®Šæ•¸
        // ============================================
        let expenseChart = null; // åœ“é¤…åœ–å¯¦ä¾‹

        // ============================================
        // æ¨™ç±¤åˆ‡æ›åŠŸèƒ½
        // ============================================
        function switchTab(tab) {
            const expenseForm = document.getElementById('form-expense');
            const installmentForm = document.getElementById('form-installment');
            const expenseTab = document.getElementById('tab-expense');
            const installmentTab = document.getElementById('tab-installment');

            if (tab === 'expense') {
                expenseForm.classList.remove('hidden');
                installmentForm.classList.add('hidden');
                expenseTab.classList.add('bg-teal-500', 'text-white');
                expenseTab.classList.remove('bg-gray-100', 'text-gray-600');
                installmentTab.classList.add('bg-gray-100', 'text-gray-600');
                installmentTab.classList.remove('bg-teal-500', 'text-white');
            } else {
                expenseForm.classList.add('hidden');
                installmentForm.classList.remove('hidden');
                installmentTab.classList.add('bg-teal-500', 'text-white');
                installmentTab.classList.remove('bg-gray-100', 'text-gray-600');
                expenseTab.classList.add('bg-gray-100', 'text-gray-600');
                expenseTab.classList.remove('bg-teal-500', 'text-white');
            }
        }

        // ============================================
        // æœ¬åœ°å„²å­˜ç®¡ç† (ä½¿ç”¨ localStorage)
        // ============================================
        
        class LocalStorage {
            static getExpenses() {
                const data = localStorage.getItem('expenses');
                return data ? JSON.parse(data) : [];
            }

            static saveExpense(expense) {
                const expenses = this.getExpenses();
                expenses.push(expense);
                localStorage.setItem('expenses', JSON.stringify(expenses));
            }

            static getInstallments() {
                const data = localStorage.getItem('installments');
                return data ? JSON.parse(data) : [];
            }

            static saveInstallment(installment) {
                const installments = this.getInstallments();
                installments.push(installment);
                localStorage.setItem('installments', JSON.stringify(installments));
            }

            static getTotalAssets() {
                const data = localStorage.getItem('totalAssets');
                return data ? Number(data) : 0;
            }

            static setTotalAssets(amount) {
                localStorage.setItem('totalAssets', amount.toString());
            }
        }

        // ============================================
        // ç¸½è³‡ç”¢ç®¡ç†
        // ============================================
        function loadTotalAssets() {
            const totalAssets = LocalStorage.getTotalAssets();
            document.getElementById('total-assets').textContent = formatCurrency(totalAssets);
        }

        // åˆ‡æ¢ç¼–è¾‘æ€»èµ„äº§åŒºåŸŸ
        function toggleEditAssets() {
            const editBtn = document.getElementById('edit-assets-btn');
            const editSection = document.getElementById('edit-assets-section');
            
            if (editSection.classList.contains('hidden')) {
                // æ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
                editSection.classList.remove('hidden');
                editBtn.classList.add('hidden');
            } else {
                // éšè—ç¼–è¾‘åŒºåŸŸ
                editSection.classList.add('hidden');
                editBtn.classList.remove('hidden');
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('assets-input').value = '';
            }
        }

        function updateTotalAssets() {
            const input = document.getElementById('assets-input');
            const newAssets = Number(input.value);

            if (isNaN(newAssets) || newAssets < 0) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡', 'error');
                return;
            }

            LocalStorage.setTotalAssets(newAssets);
            loadTotalAssets();
            showNotification('ç¸½è³‡ç”¢å·²è¨­å®š', 'success');
            input.value = '';
            // å…³é—­ç¼–è¾‘åŒºåŸŸ
            toggleEditAssets();
        }

        function addToTotalAssets() {
            const input = document.getElementById('add-assets-input');
            const addAmount = Number(input.value);

            if (isNaN(addAmount) || addAmount === 0) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡', 'error');
                return;
            }

            const currentAssets = LocalStorage.getTotalAssets();
            const newAssets = Math.max(0, currentAssets + addAmount);
            
            LocalStorage.setTotalAssets(newAssets);
            loadTotalAssets();
            
            if (addAmount > 0) {
                showNotification(`å·²æ–°å¢ ${formatCurrency(addAmount)}ï¼Œç¸½è³‡ç”¢ç¾ç‚º ${formatCurrency(newAssets)}`, 'success');
            } else {
                showNotification(`å·²æ‰£é™¤ ${formatCurrency(Math.abs(addAmount))}ï¼Œç¸½è³‡ç”¢ç¾ç‚º ${formatCurrency(newAssets)}`, 'success');
            }
            
            input.value = '';
        }

        // ============================================
        // æ—¥å¸¸æ”¯å‡ºè¨˜éŒ„
        // ============================================
        function addExpense() {
            const date = document.getElementById('expense-date').value;
            const amount = Number(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value;

            if (!date || isNaN(amount) || amount <= 0 || !category) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }

            const expense = {
                id: Date.now().toString(),
                date: date,
                amount: amount,
                category: category,
                description: description || '',
                timestamp: Date.now()
            };

            LocalStorage.saveExpense(expense);
            
            // è‡ªå‹•å¾ç¸½è³‡ç”¢æ‰£é™¤æ”¯å‡ºé‡‘é¡
            const currentAssets = LocalStorage.getTotalAssets();
            const newAssets = currentAssets - amount;
            LocalStorage.setTotalAssets(newAssets);
            loadTotalAssets();
            
            showNotification(`æ”¯å‡ºå·²è¨˜éŒ„ï¼Œç¸½è³‡ç”¢å·²æ‰£é™¤ ${formatCurrency(amount)}`, 'success');
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-category').value = 'é¤é£²';
            document.getElementById('expense-description').value = '';

            // æ›´æ–°é¡¯ç¤º
            updateMonthlySummaryAndList();
            updateExpenseChart();
        }

        // ============================================
        // ä¿¡ç”¨å¡åˆ†æœŸè¿½è¹¤
        // ============================================
        function addInstallment() {
            const totalAmount = Number(document.getElementById('installment-total').value);
            const periods = Number(document.getElementById('installment-periods').value);
            const startMonth = document.getElementById('installment-start').value;
            const category = document.getElementById('installment-category').value;
            const description = document.getElementById('installment-description').value;

            if (isNaN(totalAmount) || totalAmount <= 0) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¸½é¡', 'error');
                return;
            }
            if (isNaN(periods) || periods <= 0 || !Number.isInteger(periods)) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„æœŸæ•¸ï¼ˆæ­£æ•´æ•¸ï¼‰', 'error');
                return;
            }
            if (!startMonth || !category) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }

            const monthlyPayment = totalAmount / periods;

            const installment = {
                id: Date.now().toString(),
                totalAmount: totalAmount,
                periods: periods,
                startMonth: startMonth,
                category: category,
                description: description || '',
                monthlyPayment: monthlyPayment,
                timestamp: Date.now()
            };

            console.log('ğŸ“ æ–°å¢åˆ†æœŸè¨ˆç•«:', installment);
            LocalStorage.saveInstallment(installment);
            
            // è‡ªå‹•å¾ç¸½è³‡ç”¢æ‰£é™¤åˆ†æœŸç¸½é¡ï¼ˆå› ç‚ºé€™ç­†éŒ¢å·²ç¶“èŠ±äº†ï¼‰
            const currentAssets = LocalStorage.getTotalAssets();
            const newAssets = Math.max(0, currentAssets - totalAmount);
            LocalStorage.setTotalAssets(newAssets);
            loadTotalAssets();
            
            // é©—è­‰ä¿å­˜
            const savedInstallments = LocalStorage.getInstallments();
            console.log('ğŸ’¾ å·²ä¿å­˜çš„åˆ†æœŸè¨ˆç•«:', savedInstallments);
            
            showNotification(`åˆ†æœŸè¨ˆç•«å·²æ–°å¢ï¼Œç¸½è³‡ç”¢å·²æ‰£é™¤ ${formatCurrency(totalAmount)}`, 'success');
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('installment-total').value = '';
            document.getElementById('installment-periods').value = '';
            document.getElementById('installment-start').value = '';
            document.getElementById('installment-category').value = 'é¤é£²';
            document.getElementById('installment-description').value = '';

            // æ›´æ–°é¡¯ç¤º
            console.log('ğŸ”„ é–‹å§‹æ›´æ–°é¡¯ç¤º...');
            updateMonthlySummaryAndList();
        }

        // ============================================
        // æœˆåº¦ç¸½è¦½èˆ‡äº¤æ˜“æ¸…å–®
        // ============================================
        function updateMonthlySummaryAndList() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            let monthlyExpenses = 0;
            let monthlyInstallments = 0;
            const transactionList = [];

            // è™•ç†æ—¥å¸¸æ”¯å‡º
            const expenses = LocalStorage.getExpenses();
            expenses.forEach(expense => {
                const expenseMonth = expense.date.slice(0, 7);
                const amount = Number(expense.amount || 0);
                
                if (expenseMonth === currentMonth) {
                    monthlyExpenses += amount;
                }
                
                transactionList.push({
                    id: expense.id,
                    type: 'expense',
                    date: expense.date,
                    amount: amount,
                    category: expense.category,
                    description: expense.description,
                    timestamp: expense.timestamp
                });
            });

            // è™•ç†åˆ†æœŸè¨ˆç•«
            const installments = LocalStorage.getInstallments();
            console.log(`ğŸ’³ è™•ç†åˆ†æœŸè¨ˆç•« (ç•¶å‰æœˆä»½: ${currentMonth}):`, installments);
            
            installments.forEach((installment, index) => {
                const totalAmount = Number(installment.totalAmount || 0);
                const periods = Number(installment.periods || 1);
                const startMonth = installment.startMonth;
                const monthlyPayment = Number(installment.monthlyPayment || (totalAmount / periods));
                
                console.log(`  åˆ†æœŸ #${index + 1}:`, {
                    totalAmount,
                    periods,
                    startMonth,
                    monthlyPayment
                });
                
                if (isMonthInInstallmentRange(currentMonth, startMonth, periods)) {
                    console.log(`  âœ… åˆ†æœŸ #${index + 1} åœ¨ç¯„åœå…§ï¼ŒåŠ å…¥æœ¬æœˆæ”¯å‡º`);
                    monthlyInstallments += monthlyPayment;
                    
                    transactionList.push({
                        id: installment.id,
                        type: 'installment',
                        date: currentMonth + '-01',
                        amount: monthlyPayment,
                        category: installment.category,
                        description: `${installment.description} (åˆ†æœŸ ${periods} æœŸ)`,
                        timestamp: installment.timestamp,
                        installmentInfo: {
                            totalAmount: totalAmount,
                            periods: periods,
                            startMonth: startMonth
                        }
                    });
                } else {
                    console.log(`  âŒ åˆ†æœŸ #${index + 1} ä¸åœ¨ç¯„åœå…§`);
                }
            });
            
            console.log(`ğŸ’° æœ¬æœˆåˆ†æœŸæ”¤æç¸½é¡: ${monthlyInstallments}`);

            // æ›´æ–°å„€è¡¨æ¿
            document.getElementById('monthly-expenses').textContent = formatCurrency(monthlyExpenses);
            document.getElementById('monthly-installments').textContent = formatCurrency(monthlyInstallments);
            document.getElementById('monthly-total').textContent = formatCurrency(monthlyExpenses + monthlyInstallments);
            
            // æ¸²æŸ“äº¤æ˜“æ¸…å–®
            renderTransactionList(transactionList);
        }

        // æª¢æŸ¥æœˆä»½æ˜¯å¦åœ¨åˆ†æœŸç¯„åœå…§
        function isMonthInInstallmentRange(currentMonth, startMonth, periods) {
            const current = new Date(currentMonth + '-01');
            const start = new Date(startMonth + '-01');
            const end = new Date(start);
            end.setMonth(end.getMonth() + periods);
            
            const isInRange = current >= start && current < end;
            
            console.log(`ğŸ“… æª¢æŸ¥åˆ†æœŸç¯„åœ:`, {
                currentMonth,
                startMonth,
                periods,
                current: current.toISOString(),
                start: start.toISOString(),
                end: end.toISOString(),
                isInRange
            });
            
            return isInRange;
        }

        // æ¸²æŸ“äº¤æ˜“æ¸…å–®
        function renderTransactionList(transactions) {
            const listContainer = document.getElementById('transaction-list');
            
            const sortedTransactions = transactions
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 30);

            if (sortedTransactions.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <p>å°šç„¡äº¤æ˜“ç´€éŒ„</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = sortedTransactions.map(tx => {
                const categoryIcon = getCategoryIcon(tx.category);
                const typeLabel = tx.type === 'installment' ? 'åˆ†æœŸ' : 'æ”¯å‡º';
                const typeBadgeColor = tx.type === 'installment' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                
                return `
                    <div class="bg-white rounded-2xl p-4 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-2xl">${categoryIcon}</span>
                                    <span class="text-sm font-medium text-gray-600">${tx.category}</span>
                                    <span class="text-xs px-2 py-1 rounded-full ${typeBadgeColor}">${typeLabel}</span>
                                </div>
                                <p class="text-gray-700 font-medium">${tx.description || 'ç„¡æè¿°'}</p>
                                <p class="text-xs text-gray-400 mt-1">${tx.date}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-red-500">-${formatCurrency(tx.amount)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // åœ“é¤…åœ–åŠŸèƒ½
        // ============================================
        function updateExpenseChart() {
            const expenses = LocalStorage.getExpenses();
            const categoryStats = {};
            const categoryColors = {
                'é¤é£²': '#FF6384',
                'äº¤é€š': '#36A2EB',
                'å¨›æ¨‚': '#FFCE56',
                'è³¼ç‰©': '#4BC0C0',
                'å…¶ä»–': '#9966FF'
            };
            const categoryIcons = {
                'é¤é£²': 'ğŸ½ï¸',
                'äº¤é€š': 'ğŸš—',
                'å¨›æ¨‚': 'ğŸ®',
                'è³¼ç‰©': 'ğŸ›ï¸',
                'å…¶ä»–': 'ğŸ“'
            };

            // çµ±è¨ˆå„é¡åˆ¥çš„æ”¯å‡º
            expenses.forEach(expense => {
                const category = expense.category;
                const amount = Number(expense.amount || 0);
                
                if (!categoryStats[category]) {
                    categoryStats[category] = 0;
                }
                categoryStats[category] += amount;
            });

            // æº–å‚™åœ–è¡¨æ•¸æ“š
            const labels = Object.keys(categoryStats);
            const data = Object.values(categoryStats);
            const backgroundColor = labels.map(label => categoryColors[label] || '#999');
            
            // è¨ˆç®—ç¸½æ”¯å‡º
            const totalExpense = data.reduce((sum, val) => sum + val, 0);

            // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œé¡¯ç¤ºæç¤º
            if (totalExpense === 0) {
                const canvas = document.getElementById('expense-chart');
                const ctx = canvas.getContext('2d');
                
                // æ¸…é™¤ç¾æœ‰åœ–è¡¨
                if (expenseChart) {
                    expenseChart.destroy();
                    expenseChart = null;
                }
                
                // é¡¯ç¤ºç„¡æ•¸æ“šæç¤º
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px "Noto Sans TC"';
                ctx.fillStyle = '#9CA3AF';
                ctx.textAlign = 'center';
                ctx.fillText('å°šç„¡æ”¯å‡ºæ•¸æ“š', canvas.width / 2, canvas.height / 2);
                
                // æ¸…ç©ºåœ–ä¾‹
                document.getElementById('chart-legend').innerHTML = '';
                return;
            }

            // éŠ·æ¯€èˆŠåœ–è¡¨
            if (expenseChart) {
                expenseChart.destroy();
            }

            // å‰µå»ºæ–°åœ–è¡¨
            const ctx = document.getElementById('expense-chart').getContext('2d');
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColor,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // ä½¿ç”¨è‡ªå®šç¾©åœ–ä¾‹
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percentage = ((value / totalExpense) * 100).toFixed(1);
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // ç”Ÿæˆè‡ªå®šç¾©åœ–ä¾‹
            let legendHTML = '';
            labels.forEach((label, index) => {
                const value = data[index];
                const percentage = ((value / totalExpense) * 100).toFixed(1);
                const color = backgroundColor[index];
                const icon = categoryIcons[label] || 'ğŸ’°';
                
                legendHTML += `
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded-full" style="background-color: ${color}"></div>
                            <span>${icon} ${label}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-medium">${formatCurrency(value)}</span>
                            <span class="text-gray-500">(${percentage}%)</span>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('chart-legend').innerHTML = legendHTML;
        }

        // ============================================
        // å·¥å…·å‡½æ•¸
        // ============================================
        function formatCurrency(amount) {
            return '$' + new Intl.NumberFormat('zh-TW', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function getCategoryIcon(category) {
            const icons = {
                'é¤é£²': 'ğŸ½ï¸',
                'äº¤é€š': 'ğŸš—',
                'å¨›æ¨‚': 'ğŸ®',
                'è³¼ç‰©': 'ğŸ›ï¸',
                'å…¶ä»–': 'ğŸ“'
            };
            return icons[category] || 'ğŸ’°';
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            notificationMessage.textContent = message;
            
            notification.className = 'fixed top-4 right-4 px-6 py-3 rounded-2xl shadow-lg transition-all duration-300 z-50';
            if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
            } else {
                notification.classList.add('bg-blue-500', 'text-white');
            }
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // è¨­ç½®é»˜èªæ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expense-date').value = today;
            
            // è¨­ç½®é»˜èªæ¨™ç±¤æ¨£å¼ï¼ˆé è¨­é¡¯ç¤ºæ”¯å‡ºè¡¨å–®ï¼‰
            switchTab('expense');
            
            // è¼‰å…¥æ•¸æ“š
            loadTotalAssets();
            updateMonthlySummaryAndList();
            updateExpenseChart();
            
            console.log('âœ“ è¨˜å¸³æœ¬å·²å•Ÿå‹• (æœ¬åœ°ç‰ˆæœ¬)');
        });
    </script>
</body>
</html>

