<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>休閒風個人記帳本 (Supabase 雲端版)</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 50%, #80cbc4 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #78a1a1 0%, #5a8585 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(120, 161, 161, 0.4);
        }

        .input-field {
            transition: all 0.3s ease;
            max-width: 100%;
        }

        .input-field:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(120, 161, 161, 0.2);
        }

        .scroll-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #78a1a1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #5a8585;
        }
        
        /* 修复手机上的日期输入框溢出 */
        input[type="date"],
        input[type="month"] {
            min-width: 0;
            flex-shrink: 1;
        }
        
        /* 确保所有内容不会溢出 */
        .glass-card {
            max-width: 100%;
            overflow: hidden;
        }
        
        /* 强制所有元素不溢出 */
        input, select, textarea, button {
            max-width: 100%;
        }
        
        /* 标题响应式 */
        h1 {
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* 主容器不溢出 */
        #main-content {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        /* 日历样式 */
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .calendar-day {
            width: 14.28%;
            height: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
        }
        
        .calendar-day:hover {
            background-color: rgba(120, 161, 161, 0.1);
            transform: scale(1.05);
        }
        
        .calendar-day.today {
            background-color: rgba(120, 161, 161, 0.2);
            font-weight: bold;
        }
        
        .calendar-day.has-expense {
            background-color: rgba(255, 99, 132, 0.1);
            position: relative;
        }
        
        .calendar-day.has-expense::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background-color: #FF6384;
            border-radius: 50%;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .calendar-nav-btn {
            padding: 4px 12px;
            background: rgba(120, 161, 161, 0.1);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-nav-btn:hover {
            background: rgba(120, 161, 161, 0.2);
        }
        
        .calendar-weekday {
            font-weight: 600;
            color: #78a1a1;
            padding: 8px 0;
        }
    </style>
</head>
<body class="p-3 sm:p-4 md:p-8">
    <!-- 通知組件 -->
    <div id="notification" class="hidden fixed top-4 right-4 px-6 py-3 rounded-2xl shadow-lg z-50">
        <p id="notification-message" class="font-medium"></p>
    </div>

    <!-- 日期支出詳情模態框 -->
    <div id="date-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) closeDateDetail()">
        <div class="glass-card rounded-3xl p-6 sm:p-8 max-w-2xl w-full max-h-[80vh] shadow-2xl flex flex-col">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-teal-800 flex items-center gap-2">
                    <span>📅</span>
                    <span id="date-detail-title">日期支出詳情</span>
                </h3>
                <div class="flex items-center gap-2">
                    <button 
                        id="date-edit-mode-btn"
                        onclick="toggleDateEditMode()"
                        class="px-3 py-1 text-sm bg-teal-500 hover:bg-teal-600 text-white rounded-lg transition-colors"
                    >
                        ✏️ 編輯
                    </button>
                    <button 
                        id="date-done-edit-btn"
                        onclick="toggleDateEditMode()"
                        class="hidden px-3 py-1 text-sm bg-gray-400 hover:bg-gray-500 text-white rounded-lg transition-colors"
                    >
                        ✓ 完成
                    </button>
                    <button 
                        onclick="closeDateDetail()"
                        class="px-3 py-1 text-sm bg-gray-400 hover:bg-gray-500 text-white rounded-lg transition-colors"
                    >
                        ✕ 關閉
                    </button>
                </div>
            </div>
            <div id="date-transaction-list" class="flex-1 overflow-y-auto space-y-3 pr-2">
                <!-- 該日期的交易紀錄將動態載入 -->
                <div class="text-center text-gray-400 py-8">
                    <p>載入中...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯交易模態框 -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) cancelEdit()">
        <div class="glass-card rounded-3xl p-6 sm:p-8 max-w-md w-full shadow-2xl">
            <h3 class="text-2xl font-bold text-teal-800 mb-6">編輯交易</h3>
            
            <div class="space-y-4">
                <!-- 日常支出表单 -->
                <div id="edit-expense-fields">
                    <!-- 金额输入 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">金額</label>
                        <input 
                            type="number" 
                            id="edit-amount" 
                            placeholder="輸入金額"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            min="0"
                            step="1"
                        >
                    </div>
                </div>

                <!-- 分期计划表单 -->
                <div id="edit-installment-fields" class="hidden">
                    <!-- 总额输入 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">總額</label>
                        <input 
                            type="number" 
                            id="edit-total-amount" 
                            placeholder="輸入總額"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            min="0"
                            step="1"
                        >
                    </div>

                    <!-- 期数输入 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">期數</label>
                        <input 
                            type="number" 
                            id="edit-periods" 
                            placeholder="分幾期"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            min="1"
                            step="1"
                        >
                    </div>

                    <!-- 开始月份输入 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始月份</label>
                        <input 
                            type="month" 
                            id="edit-start-month" 
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none cursor-pointer"
                            onclick="this.showPicker()"
                        >
                    </div>
                </div>

                <!-- 类别下拉选单（两种表单共用） -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">類別</label>
                    <select 
                        id="edit-category"
                        class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                    >
                        <option value="餐飲">🍽️ 餐飲</option>
                        <option value="交通">🚗 交通</option>
                        <option value="娛樂">🎮 娛樂</option>
                        <option value="購物">🛍️ 購物</option>
                        <option value="其他">📝 其他</option>
                    </select>
                </div>

                <!-- 按钮组 -->
                <div class="flex gap-3 mt-6">
                    <button 
                        onclick="cancelEdit()"
                        class="flex-1 py-3 px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-2xl font-medium transition-colors"
                    >
                        取消
                    </button>
                    <button 
                        onclick="confirmEdit()"
                        class="flex-1 btn-primary py-3 px-4 rounded-2xl text-white font-medium"
                    >
                        確認
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入中狀態 -->
    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-teal-600 mb-4"></div>
            <p class="text-teal-700 font-medium text-lg">連接雲端數據庫...</p>
        </div>
    </div>

    <!-- 登入/註冊界面 -->
    <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-md">
            <!-- Logo 和標題 -->
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-teal-800 mb-2">💰</h1>
                <h2 class="text-2xl md:text-3xl font-bold text-teal-800 mb-2">休閒風個人記帳本</h2>
                <p class="text-teal-600">輕鬆管理您的財務，追蹤每一筆支出</p>
            </div>

            <!-- 登入/註冊卡片 -->
            <div class="glass-card rounded-3xl p-6 sm:p-8 shadow-xl">
                <!-- 標籤切換 -->
                <div class="flex gap-2 mb-6">
                    <button 
                        id="tab-login"
                        onclick="switchAuthTab('login')"
                        class="flex-1 py-3 px-4 rounded-2xl font-medium transition-all bg-teal-500 text-white"
                    >
                        登入
                    </button>
                    <button 
                        id="tab-signup"
                        onclick="switchAuthTab('signup')"
                        class="flex-1 py-3 px-4 rounded-2xl font-medium transition-all bg-gray-100 text-gray-600"
                    >
                        註冊
                    </button>
                </div>

                <!-- Google 快速登入 -->
                <button 
                    onclick="signInWithGoogle()"
                    class="w-full mb-6 py-3 px-4 bg-white border-2 border-gray-300 rounded-2xl font-medium text-gray-700 hover:bg-gray-50 transition-all flex items-center justify-center gap-3"
                >
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>使用 Google 帳號登入</span>
                </button>

                <div class="relative mb-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">或使用郵箱</span>
                    </div>
                </div>

                <!-- 登入表單 -->
                <div id="form-login" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">電子郵件</label>
                        <input 
                            type="email" 
                            id="login-email" 
                            placeholder="your@email.com"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            autocomplete="email"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">密碼</label>
                        <input 
                            type="password" 
                            id="login-password" 
                            placeholder="請輸入密碼"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            autocomplete="current-password"
                        >
                    </div>
                    <button 
                        onclick="signInWithEmail()"
                        class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                    >
                        登入
                    </button>
                </div>

                <!-- 註冊表單 -->
                <div id="form-signup" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">電子郵件</label>
                        <input 
                            type="email" 
                            id="signup-email" 
                            placeholder="your@email.com"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            autocomplete="email"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">密碼</label>
                        <input 
                            type="password" 
                            id="signup-password" 
                            placeholder="至少 6 個字符"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            autocomplete="new-password"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">確認密碼</label>
                        <input 
                            type="password" 
                            id="signup-password-confirm" 
                            placeholder="再次輸入密碼"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            autocomplete="new-password"
                        >
                    </div>
                    <button 
                        onclick="signUpWithEmail()"
                        class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                    >
                        註冊
                    </button>
                </div>
            </div>

            <!-- 提示信息 -->
            <p class="text-center text-sm text-teal-600 mt-6">
                使用 Google 登入可快速開始使用 ⚡
            </p>
        </div>
    </div>

    <!-- 主要內容 -->
    <div id="main-content" class="hidden max-w-7xl mx-auto">
        <!-- 標題 -->
        <header class="mb-6 sm:mb-8">
            <!-- 用户信息栏（右上角） -->
            <div class="flex justify-end items-center mb-4">
                <div class="relative">
                    <button 
                        id="user-menu-btn"
                        onclick="toggleUserMenu()"
                        class="flex items-center gap-2 px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors"
                    >
                        <span id="user-email">用戶</span>
                        <span class="text-xs">▼</span>
                    </button>
                    <!-- 下拉菜单 -->
                    <div 
                        id="user-menu"
                        class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50"
                    >
                        <button 
                            onclick="signOut()"
                            class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-2"
                        >
                            <span>🚪</span>
                            <span>登出</span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- 主标题 -->
            <div class="text-center">
                <h1 class="text-2xl sm:text-3xl md:text-5xl font-bold text-teal-800 mb-2">💰 休閒風個人記帳本</h1>
                <p class="text-sm sm:text-base text-teal-600">輕鬆管理您的財務，追蹤每一筆支出</p>
                <p class="text-xs sm:text-sm text-teal-500 mt-2">☁️ Supabase 雲端版</p>
            </div>
        </header>

        <!-- 響應式佈局 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 左側：資產總覽與月度總覽 -->
            <div class="space-y-6">
                <!-- 總資產卡片 -->
                <div class="glass-card rounded-3xl p-6 sm:p-8 shadow-xl">
                    <!-- 总资产标题和图标（居中放大） -->
                    <div class="text-center mb-6">
                        <div class="flex items-center justify-center gap-3 mb-4">
                            <span class="text-5xl sm:text-6xl">💎</span>
                            <h2 class="text-3xl sm:text-4xl font-bold text-teal-800">總資產</h2>
                        </div>
                        <p class="text-5xl sm:text-6xl font-bold text-teal-700 mb-8" id="total-assets">$0</p>
                    </div>
                    
                    <!-- 新增资产按钮 -->
                    <button 
                        onclick="promptAddAssets()"
                        class="btn-primary w-full py-4 rounded-2xl text-white font-medium text-lg"
                    >
                        ➕ 新增資產
                    </button>
                </div>

                <!-- 日曆 -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-teal-800 flex items-center gap-2">
                            <span>📅</span>
                            <span>日曆</span>
                        </h2>
                        <!-- 新增支出按钮 -->
                        <button 
                            onclick="showAddExpenseModal()"
                            class="px-4 py-2 text-sm bg-teal-500 hover:bg-teal-600 text-white rounded-lg transition-colors flex items-center gap-2"
                        >
                            <span>➕</span>
                            <span>新增支出</span>
                        </button>
                    </div>
                    <div id="calendar-container" class="mb-4">
                        <!-- 日历将动态生成 -->
                    </div>
                </div>

                <!-- 本月支出預覽 -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>📊</span>
                        <span>本月支出預覽</span>
                    </h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">一般支出</span>
                            <span class="font-bold text-red-500" id="monthly-expenses">$0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">分期攤提</span>
                            <span class="font-bold text-purple-500" id="monthly-installments">$0</span>
                        </div>
                        <div class="border-t-2 border-teal-200 pt-3 flex justify-between items-center">
                            <span class="text-lg font-bold text-teal-800">本月總計</span>
                            <span class="text-2xl font-bold text-teal-700" id="monthly-total">$0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側：支出類型統計 -->
            <div class="space-y-6">
                <!-- 支出類型統計 -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>🥧</span>
                        <span>支出類型統計</span>
                    </h2>
                    <div class="relative" style="height: 280px;">
                        <canvas id="expense-chart"></canvas>
                    </div>
                    <div id="chart-legend" class="mt-4 space-y-2">
                        <!-- 圖例將動態生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增支出模態框 -->
        <div id="add-expense-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) closeAddExpenseModal()">
            <div class="glass-card rounded-3xl p-6 sm:p-8 max-w-md w-full shadow-2xl">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-teal-800">新增支出</h3>
                    <button 
                        onclick="closeAddExpenseModal()"
                        class="px-3 py-1 text-sm bg-gray-400 hover:bg-gray-500 text-white rounded-lg transition-colors"
                    >
                        ✕ 關閉
                    </button>
                </div>
                
                <!-- 標籤切換 -->
                <div class="flex gap-2 mb-6">
                    <button 
                        id="modal-tab-expense"
                        onclick="switchModalTab('expense')"
                        class="flex-1 py-3 px-4 rounded-2xl font-medium transition-all bg-teal-500 text-white"
                    >
                        📝 日常支出
                    </button>
                    <button 
                        id="modal-tab-installment"
                        onclick="switchModalTab('installment')"
                        class="flex-1 py-3 px-4 rounded-2xl font-medium transition-all bg-gray-100 text-gray-600"
                    >
                        💳 分期計畫
                    </button>
                </div>

                <!-- 新增日常支出表單 -->
                <div id="modal-form-expense" class="form-content">
                    <form class="space-y-4" onsubmit="event.preventDefault(); addExpense();">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">日期</label>
                                <input 
                                    type="date" 
                                    id="expense-date" 
                                    required
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">金額</label>
                                <input 
                                    type="number" 
                                    id="expense-amount" 
                                    placeholder="輸入金額"
                                    required
                                    min="0"
                                    step="1"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">類別</label>
                                <select 
                                    id="expense-category"
                                    required
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                                    <option value="餐飲">🍽️ 餐飲</option>
                                    <option value="交通">🚗 交通</option>
                                    <option value="娛樂">🎮 娛樂</option>
                                    <option value="購物">🛍️ 購物</option>
                                    <option value="其他">📝 其他</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">描述</label>
                                <input 
                                    type="text" 
                                    id="expense-description" 
                                    placeholder="項目描述（選填）"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <button 
                                type="submit"
                                class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                            >
                                新增支出
                            </button>
                        </form>
                    </div>

                    <!-- 新增分期計畫表單 -->
                    <div id="modal-form-installment" class="form-content hidden">
                        <form class="space-y-4" onsubmit="event.preventDefault(); addInstallment();">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">總額</label>
                                <input 
                                    type="number" 
                                    id="installment-total" 
                                    placeholder="輸入總金額"
                                    min="0"
                                    step="1"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">期數</label>
                                <input 
                                    type="number" 
                                    id="installment-periods" 
                                    placeholder="分幾期"
                                    min="1"
                                    step="1"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">開始月份</label>
                                <input 
                                    type="month" 
                                    id="installment-start" 
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none cursor-pointer"
                                    onclick="this.showPicker()"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">類別</label>
                                <select 
                                    id="installment-category"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                                    <option value="餐飲">🍽️ 餐飲</option>
                                    <option value="交通">🚗 交通</option>
                                    <option value="娛樂">🎮 娛樂</option>
                                    <option value="購物">🛍️ 購物</option>
                                    <option value="其他">📝 其他</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">描述</label>
                                <input 
                                    type="text" 
                                    id="installment-description" 
                                    placeholder="項目描述（選填）"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <button 
                                type="submit"
                                class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                            >
                                新增分期計畫
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 頁尾 -->
        <footer class="text-center mt-12 text-teal-600">
            <p class="text-sm">© 2025 休閒風個人記帳本 | 輕鬆管理，精彩生活 ✨</p>
        </footer>
    </div>

    <script type="module">
        // ============================================
        // Supabase 配置（請替換為您的實際值）
        // ============================================
        const SUPABASE_URL = 'https://cgptfjacrtbzcilkzusq.supabase.co';  // 替換為您的 Supabase Project URL
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNncHRmamFjcnRiemNpbGt6dXNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MjUyNTcsImV4cCI6MjA3NzQwMTI1N30.vuoJpoV6zcVWnzBHxFJue3QawoPj7tPe0vk3w0hjTgs';  // 替換為您的 anon public key

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================
        // 全域變數
        // ============================================
        let expenseChart = null;
        let currentUser = null;

        // ============================================
        // 認證與初始化
        // ============================================
        
        // 切换登录/注册标签
        window.switchAuthTab = function(tab) {
            const loginTab = document.getElementById('tab-login');
            const signupTab = document.getElementById('tab-signup');
            const loginForm = document.getElementById('form-login');
            const signupForm = document.getElementById('form-signup');

            if (tab === 'login') {
                loginTab.classList.add('bg-teal-500', 'text-white');
                loginTab.classList.remove('bg-gray-100', 'text-gray-600');
                signupTab.classList.remove('bg-teal-500', 'text-white');
                signupTab.classList.add('bg-gray-100', 'text-gray-600');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                signupTab.classList.add('bg-teal-500', 'text-white');
                signupTab.classList.remove('bg-gray-100', 'text-gray-600');
                loginTab.classList.remove('bg-teal-500', 'text-white');
                loginTab.classList.add('bg-gray-100', 'text-gray-600');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        };

        // Google 登入
        window.signInWithGoogle = async function() {
            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + window.location.pathname
                    }
                });
                
                if (error) throw error;
                console.log('✓ 正在跳轉到 Google 登入...');
            } catch (error) {
                console.error('Google 登入失敗:', error);
                showNotification('Google 登入失敗: ' + error.message, 'error');
            }
        };

        // 郵箱登入
        window.signInWithEmail = async function() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showNotification('請輸入郵箱和密碼', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentUser = data.user;
                console.log('✓ 登入成功:', currentUser.id);
                showNotification('登入成功！', 'success');
                
                // 初始化應用
                await initializeMainApp();
            } catch (error) {
                console.error('登入失敗:', error);
                showNotification('登入失敗: ' + error.message, 'error');
            }
        };

        // 郵箱註冊
        window.signUpWithEmail = async function() {
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const passwordConfirm = document.getElementById('signup-password-confirm').value;

            if (!email || !password || !passwordConfirm) {
                showNotification('請填寫所有欄位', 'error');
                return;
            }

            if (password !== passwordConfirm) {
                showNotification('兩次密碼輸入不一致', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('密碼至少需要 6 個字符', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        emailRedirectTo: window.location.origin + window.location.pathname
                    }
                });

                if (error) throw error;

                if (data.user) {
                    // 检查是否需要邮箱验证
                    if (data.user.identities && data.user.identities.length === 0) {
                        showNotification('此郵箱已被註冊，請直接登入', 'error');
                        switchAuthTab('login');
                        document.getElementById('login-email').value = email;
                    } else {
                        showNotification('註冊成功！請檢查您的郵箱進行驗證（如需要）', 'success');
                        // 某些配置下可能会自动登录
                        if (data.session) {
                            currentUser = data.user;
                            await initializeMainApp();
                        } else {
                            // 切换到登录界面
                            setTimeout(() => {
                                switchAuthTab('login');
                                document.getElementById('login-email').value = email;
                            }, 2000);
                        }
                    }
                }
            } catch (error) {
                console.error('註冊失敗:', error);
                showNotification('註冊失敗: ' + error.message, 'error');
            }
        };

        // 切换用户菜单
        window.toggleUserMenu = function() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        };
        
        // 点击外部关闭菜单
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('user-menu');
            const menuBtn = document.getElementById('user-menu-btn');
            if (!menu.contains(event.target) && !menuBtn.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // 登出
        window.signOut = async function() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;

                console.log('✓ 已登出');
                showNotification('已登出', 'success');
                
                // 清空用户信息
                currentUser = null;
                
                // 关闭用户菜单
                document.getElementById('user-menu').classList.add('hidden');
                
                // 显示登录界面
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            } catch (error) {
                console.error('登出失敗:', error);
                showNotification('登出失敗: ' + error.message, 'error');
            }
        };

        // 初始化主应用
        async function initializeMainApp() {
            try {
                // 更新用户信息显示
                const userEmailElement = document.getElementById('user-email');
                if (currentUser.email) {
                    userEmailElement.textContent = currentUser.email;
                } else if (currentUser.user_metadata && currentUser.user_metadata.full_name) {
                    userEmailElement.textContent = currentUser.user_metadata.full_name;
                } else {
                    userEmailElement.textContent = '用戶 ' + currentUser.id.substring(0, 8);
                }

                // 載入數據
                await loadTotalAssets();
                await updateMonthlySummaryAndList();
                await updateExpenseChart();
                
                // 顯示主要內容
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                console.log('✓ 應用程式已啟動');
            } catch (error) {
                console.error('初始化失敗:', error);
                showNotification('初始化失敗: ' + error.message, 'error');
            }
        }

        // 检查登录状态
        async function initializeApp() {
            try {
                // 檢查當前用戶
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                if (user) {
                    currentUser = user;
                    console.log('✓ 用戶已登入:', user.id);
                    await initializeMainApp();
                } else {
                    // 显示登录界面
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('auth-screen').classList.remove('hidden');
                    console.log('请登入');
                }
            } catch (error) {
                console.error('初始化失敗:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        }

        // 监听认证状态变化
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth event:', event);
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                console.log('✓ 用戶已登入:', currentUser.id);
                initializeMainApp();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        // ============================================
        // 總資產管理
        // ============================================
        async function loadTotalAssets() {
            try {
                const { data, error } = await supabaseClient
                    .from('assets')
                    .select('total_assets')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                // 如果没有数据，显示 0
                const totalAssets = data ? Number(data.total_assets || 0) : 0;
                document.getElementById('total-assets').textContent = formatCurrency(totalAssets);
                
                console.log('💰 总资产:', totalAssets);
            } catch (error) {
                console.error('載入總資產失敗:', error);
                document.getElementById('total-assets').textContent = formatCurrency(0);
            }
        }

        // 切换编辑总资产区域
        // 弹出输入框新增资产
        window.promptAddAssets = async function() {
            const inputAmount = prompt('請輸入要新增的金額（可輸入負數來扣除）:');
            
            if (inputAmount === null) return; // 用户取消
            
            const addAmount = Number(inputAmount);

            if (isNaN(addAmount) || addAmount === 0) {
                showNotification('請輸入有效的金額', 'error');
                return;
            }

            try {
                // 獲取當前總資產
                const { data: assetsData } = await supabaseClient
                    .from('assets')
                    .select('total_assets')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                const newAssets = Math.max(0, currentAssets + addAmount);

                // 更新總資產
                const { error } = await supabaseClient
                    .from('assets')
                    .upsert({
                        user_id: currentUser.id,
                        total_assets: newAssets,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) throw error;

                console.log('✅ 资产已新增:', addAmount, '新总资产:', newAssets);
                await loadTotalAssets();
                
                if (addAmount > 0) {
                    showNotification(`已新增 ${formatCurrency(addAmount)}，總資產現為 ${formatCurrency(newAssets)}`, 'success');
                } else {
                    showNotification(`已扣除 ${formatCurrency(Math.abs(addAmount))}，總資產現為 ${formatCurrency(newAssets)}`, 'success');
                }
            } catch (error) {
                console.error('新增資產失敗:', error);
                showNotification(`操作失敗: ${error.message}`, 'error');
            }
        };

        // ============================================
        // 日常支出記錄
        // ============================================
        window.addExpense = async function() {
            const date = document.getElementById('expense-date').value;
            const amount = Number(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value;

            if (!date || isNaN(amount) || amount <= 0 || !category) {
                showNotification('請填寫所有必填欄位', 'error');
                return;
            }

            try {
                // 新增支出
                const { error } = await supabaseClient
                    .from('expenses')
                    .insert({
                        user_id: currentUser.id,
                        date: date,
                        amount: amount,
                        category: category,
                        description: description || ''
                    });

                if (error) throw error;

                // 自動從總資產扣除
                const { data: assetsData } = await supabaseClient
                    .from('assets')
                    .select('total_assets')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                const newAssets = Math.max(0, currentAssets - amount); // 不允许负数
                
                await supabaseClient
                    .from('assets')
                    .upsert({
                        user_id: currentUser.id,
                        total_assets: newAssets,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });

                await loadTotalAssets();
                showNotification(`支出已記錄，總資產已扣除 ${formatCurrency(amount)}`, 'success');
                
                // 清空表單
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-category').value = '餐飲';
                document.getElementById('expense-description').value = '';

                // 更新顯示
                await updateMonthlySummaryAndList();
                await updateExpenseChart();
                
                // 關閉模態框
                closeAddExpenseModal();
            } catch (error) {
                console.error('新增支出失敗:', error);
                showNotification('新增失敗，請稍後再試', 'error');
            }
        };

        // ============================================
        // 信用卡分期追蹤
        // ============================================
        window.addInstallment = async function() {
            const totalAmount = Number(document.getElementById('installment-total').value);
            const periods = Number(document.getElementById('installment-periods').value);
            const startMonth = document.getElementById('installment-start').value;
            const category = document.getElementById('installment-category').value;
            const description = document.getElementById('installment-description').value;

            if (isNaN(totalAmount) || totalAmount <= 0) {
                showNotification('請輸入有效的總額', 'error');
                return;
            }
            if (isNaN(periods) || periods <= 0 || !Number.isInteger(periods)) {
                showNotification('請輸入有效的期數（正整數）', 'error');
                return;
            }
            if (!startMonth || !category) {
                showNotification('請填寫所有必填欄位', 'error');
                return;
            }

            const monthlyPayment = totalAmount / periods;

            try {
                // 新增分期計畫
                const { error } = await supabaseClient
                    .from('installments')
                    .insert({
                        user_id: currentUser.id,
                        total_amount: totalAmount,
                        periods: periods,
                        start_month: startMonth,
                        category: category,
                        description: description || '',
                        monthly_payment: monthlyPayment
                    });

                if (error) throw error;

                // 檢查當前月份是否需要扣除分期金額
                // ⚠️ 重要：只扣除當月分期攤提金額，不是總額！
                const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                let deductAmount = 0;
                let notificationMessage = '分期計畫已新增';

                console.log('📋 分期計劃資訊:', {
                    totalAmount,
                    periods,
                    monthlyPayment,
                    startMonth,
                    currentMonth
                });

                // 如果當前月份在分期範圍內，扣除當月應還金額（不是總額！）
                if (startMonth <= currentMonth) {
                    // 計算當前月份是第幾期
                    const startDate = new Date(startMonth + '-01');
                    const currentDate = new Date(currentMonth + '-01');
                    const monthsDiff = (currentDate.getFullYear() - startDate.getFullYear()) * 12 + 
                                     (currentDate.getMonth() - startDate.getMonth());
                    
                    console.log('📅 月份計算:', {
                        startMonth,
                        currentMonth,
                        monthsDiff,
                        periods
                    });
                    
                    // 如果還在分期期數內，扣除當月金額（monthlyPayment，不是totalAmount！）
                    if (monthsDiff >= 0 && monthsDiff < periods) {
                        deductAmount = monthlyPayment; // ✅ 只扣除當月攤提
                        console.log('✅ 扣除當月分期金額:', deductAmount, '(不是總額', totalAmount, ')');
                    } else {
                        console.log('⚠️ 當前月份不在分期範圍內');
                    }
                } else {
                    console.log('⏰ 分期尚未開始，不扣除');
                }

                // ⚠️ 只扣除當月分期金額，不是總額！
                if (deductAmount > 0) {
                    const { data: assetsData } = await supabaseClient
                        .from('assets')
                        .select('total_assets')
                        .eq('user_id', currentUser.id)
                        .maybeSingle();

                    const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                    const newAssets = Math.max(0, currentAssets - deductAmount); // ✅ 只扣除 deductAmount
                    
                    console.log('💰 總資產調整:', {
                        currentAssets,
                        deductAmount,
                        newAssets
                    });
                    
                    await supabaseClient
                        .from('assets')
                        .upsert({
                            user_id: currentUser.id,
                            total_assets: newAssets,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id'
                        });

                    notificationMessage += `，本月已扣除 ${formatCurrency(deductAmount)}`;
                } else if (startMonth > currentMonth) {
                    notificationMessage += '（尚未開始扣款）';
                }

                await loadTotalAssets();
                showNotification(notificationMessage, 'success');
                
                // 清空表單
                document.getElementById('installment-total').value = '';
                document.getElementById('installment-periods').value = '';
                document.getElementById('installment-start').value = '';
                document.getElementById('installment-category').value = '餐飲';
                document.getElementById('installment-description').value = '';

                // 更新顯示
                await updateMonthlySummaryAndList();
                
                // 關閉模態框
                closeAddExpenseModal();
            } catch (error) {
                console.error('新增分期計畫失敗:', error);
                showNotification('新增失敗，請稍後再試', 'error');
            }
        };

        // ============================================
        // 月度總覽與交易清單
        // ============================================
        async function updateMonthlySummaryAndList() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            let monthlyExpenses = 0;
            let monthlyInstallments = 0;
            const transactionList = [];

            try {
                // 獲取日常支出
                const { data: expenses, error: expensesError } = await supabaseClient
                    .from('expenses')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (expensesError) throw expensesError;

                expenses?.forEach(expense => {
                    const expenseMonth = expense.date.slice(0, 7);
                    const amount = Number(expense.amount || 0);
                    
                    if (expenseMonth === currentMonth) {
                        monthlyExpenses += amount;
                    }
                    
                    transactionList.push({
                        id: expense.id,
                        type: 'expense',
                        date: expense.date,
                        amount: amount,
                        category: expense.category,
                        description: expense.description,
                        timestamp: new Date(expense.created_at).getTime()
                    });
                });

                // 獲取分期計畫
                const { data: installments, error: installmentsError } = await supabaseClient
                    .from('installments')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (installmentsError) throw installmentsError;

                installments?.forEach(installment => {
                    const totalAmount = Number(installment.total_amount || 0);
                    const periods = Number(installment.periods || 1);
                    const startMonth = installment.start_month;
                    const monthlyPayment = Number(installment.monthly_payment || (totalAmount / periods));
                    
                    if (isMonthInInstallmentRange(currentMonth, startMonth, periods)) {
                        monthlyInstallments += monthlyPayment;
                        
                        transactionList.push({
                            id: installment.id,
                            type: 'installment',
                            date: currentMonth + '-01',
                            amount: monthlyPayment,
                            category: installment.category,
                            description: `${installment.description} (分期 ${periods} 期)`,
                            timestamp: new Date(installment.created_at).getTime()
                        });
                    }
                });

                // 更新儀表板
                document.getElementById('monthly-expenses').textContent = formatCurrency(monthlyExpenses);
                document.getElementById('monthly-installments').textContent = formatCurrency(monthlyInstallments);
                document.getElementById('monthly-total').textContent = formatCurrency(monthlyExpenses + monthlyInstallments);
                
                // 保存交易数据供日历使用
                allTransactions = transactionList;
                
                // 渲染日历
                renderCalendar();
            } catch (error) {
                console.error('更新月度總覽失敗:', error);
            }
        }
        
        // 渲染日历
        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            
            // 获取月份第一天和最后一天
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // 获取有交易的日期
            const expenseDates = new Set();
            allTransactions.forEach(tx => {
                expenseDates.add(tx.date);
            });
            
            // 今天的日期
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            const todayDate = today.getDate();
            
            // 构建日历HTML
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            
            let calendarHTML = `
                <div class="calendar-header">
                    <button onclick="changeCalendarMonth(-1)" class="calendar-nav-btn">← 上月</button>
                    <h3 class="text-lg font-bold text-teal-800">${year}年 ${monthNames[month]}</h3>
                    <button onclick="changeCalendarMonth(1)" class="calendar-nav-btn">下月 →</button>
                </div>
                <table class="calendar-table">
                    <thead>
                        <tr>
                            ${weekdays.map(day => `<th class="calendar-weekday text-xs">${day}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let day = 1;
            for (let i = 0; i < 6; i++) {
                calendarHTML += '<tr>';
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < startingDayOfWeek) {
                        calendarHTML += '<td></td>';
                    } else if (day > daysInMonth) {
                        calendarHTML += '<td></td>';
                    } else {
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const hasExpense = expenseDates.has(dateStr);
                        const isToday = isCurrentMonth && day === todayDate;
                        
                        let dayClasses = 'calendar-day';
                        if (isToday) dayClasses += ' today';
                        if (hasExpense) dayClasses += ' has-expense';
                        
                        calendarHTML += `
                            <td>
                                <div class="${dayClasses}" onclick="showDateDetail('${dateStr}')">
                                    ${day}
                                </div>
                            </td>
                        `;
                        day++;
                    }
                }
                calendarHTML += '</tr>';
                if (day > daysInMonth) break;
            }
            
            calendarHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = calendarHTML;
        }
        
        // 切换日历月份
        window.changeCalendarMonth = function(direction) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
            renderCalendar();
        };
        
        // 显示日期详情
        window.showDateDetail = async function(dateStr) {
            // 获取该日期的所有交易
            const dayTransactions = allTransactions.filter(tx => tx.date === dateStr);
            
            // 格式化日期显示
            const date = new Date(dateStr);
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            const weekday = weekdays[date.getDay()];
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(date);
            targetDate.setHours(0, 0, 0, 0);
            
            let dateLabel = `${year}年${month}月${day}日 星期${weekday}`;
            if (targetDate.getTime() === today.getTime()) {
                dateLabel = `今天 (${year}年${month}月${day}日)`;
            } else if (targetDate.getTime() === today.getTime() - 86400000) {
                dateLabel = `昨天 (${year}年${month}月${day}日)`;
            }
            
            document.getElementById('date-detail-title').textContent = dateLabel;
            
            // 渲染该日期的交易列表
            renderDateTransactionList(dayTransactions, dateStr);
            
            // 显示模态框
            document.getElementById('date-detail-modal').classList.remove('hidden');
        };
        
        // 关闭日期详情
        window.closeDateDetail = function() {
            document.getElementById('date-detail-modal').classList.add('hidden');
            isDateEditMode = false;
            const editBtn = document.getElementById('date-edit-mode-btn');
            const doneBtn = document.getElementById('date-done-edit-btn');
            editBtn.classList.remove('hidden');
            doneBtn.classList.add('hidden');
        };
        
        // 切换日期编辑模式
        window.toggleDateEditMode = function() {
            isDateEditMode = !isDateEditMode;
            const editBtn = document.getElementById('date-edit-mode-btn');
            const doneBtn = document.getElementById('date-done-edit-btn');
            
            if (isDateEditMode) {
                editBtn.classList.add('hidden');
                doneBtn.classList.remove('hidden');
            } else {
                editBtn.classList.remove('hidden');
                doneBtn.classList.add('hidden');
            }
            
            // 重新渲染交易列表
            const dateTitle = document.getElementById('date-detail-title').textContent;
            // 从标题中提取日期
            const dateMatch = dateTitle.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
            if (dateMatch) {
                const year = dateMatch[1];
                const month = String(dateMatch[2]).padStart(2, '0');
                const day = String(dateMatch[3]).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                const dayTransactions = allTransactions.filter(tx => tx.date === dateStr);
                renderDateTransactionList(dayTransactions, dateStr);
            }
        };
        
        // 渲染日期交易列表
        function renderDateTransactionList(transactions, dateStr) {
            const container = document.getElementById('date-transaction-list');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <p>該日期尚無交易紀錄</p>
                    </div>
                `;
                return;
            }
            
            // 按时间排序（最新的在前）
            const sorted = transactions.sort((a, b) => b.timestamp - a.timestamp);
            
            // 计算当天总支出
            const dayTotal = sorted.reduce((sum, tx) => sum + Number(tx.amount || 0), 0);
            
            const transactionsHtml = sorted.map(tx => {
                const categoryIcon = getCategoryIcon(tx.category);
                const typeLabel = tx.type === 'installment' ? '分期' : '支出';
                const typeBadgeColor = tx.type === 'installment' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                
                // 编辑模式下显示编辑和删除按钮
                const periods = tx.periods || 0;
                const startMonth = tx.start_month || '';
                const editButtons = isDateEditMode ? `
                    <div class="flex gap-2 mt-2">
                        <button 
                            onclick="editTransaction('${tx.id}', '${tx.type}', ${tx.amount}, '${tx.category}', ${periods}, '${startMonth}')"
                            class="flex-1 px-3 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
                        >
                            編輯
                        </button>
                        <button 
                            onclick="deleteTransaction('${tx.id}', '${tx.type}')"
                            class="flex-1 px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
                        >
                            刪除
                        </button>
                    </div>
                ` : '';
                
                return `
                    <div class="bg-white rounded-2xl p-4 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-2xl">${categoryIcon}</span>
                                    <span class="text-sm font-medium text-gray-600">${tx.category}</span>
                                    <span class="text-xs px-2 py-1 rounded-full ${typeBadgeColor}">${typeLabel}</span>
                                </div>
                                <p class="text-gray-700 font-medium">${tx.description || '無描述'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-red-500">-${formatCurrency(tx.amount)}</p>
                            </div>
                        </div>
                        ${editButtons}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="mb-4 pb-4 border-b-2 border-teal-200">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold text-teal-700">當日總計</span>
                        <span class="text-2xl font-bold text-teal-700">${formatCurrency(dayTotal)}</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">共 ${sorted.length} 筆交易</p>
                </div>
                <div class="space-y-3">
                    ${transactionsHtml}
                </div>
            `;
        }

        // 檢查月份是否在分期範圍內
        function isMonthInInstallmentRange(currentMonth, startMonth, periods) {
            const current = new Date(currentMonth + '-01');
            const start = new Date(startMonth + '-01');
            const end = new Date(start);
            end.setMonth(end.getMonth() + periods);
            
            return current >= start && current < end;
        }

        // 全局编辑模式状态
        let isEditMode = false;
        let isDateEditMode = false;
        
        // 存储所有交易数据（用于日历）
        let allTransactions = [];
        
        // 当前显示的日历月份
        let currentCalendarMonth = new Date();

        // 切换编辑模式
        window.toggleEditMode = function() {
            isEditMode = !isEditMode;
            const editBtn = document.getElementById('edit-mode-btn');
            const doneBtn = document.getElementById('done-edit-btn');
            
            if (isEditMode) {
                editBtn.classList.add('hidden');
                doneBtn.classList.remove('hidden');
            } else {
                editBtn.classList.remove('hidden');
                doneBtn.classList.add('hidden');
            }
            
            // 重新渲染交易列表
            updateMonthlySummaryAndList();
        };

        // 删除交易
        window.deleteTransaction = async function(id, type) {
            if (!confirm('確定要刪除這筆交易嗎？')) {
                return;
            }

            try {
                let refundAmount = 0;
                
                // 先获取要删除的数据（用于退还资产）
                if (type === 'installment') {
                    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                    const { data: installmentData } = await supabaseClient
                        .from('installments')
                        .select('total_amount, periods, start_month, monthly_payment')
                        .eq('id', id)
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    if (installmentData) {
                        const startMonth = installmentData.start_month;
                        const monthlyPayment = Number(installmentData.monthly_payment || 0);
                        
                        // 只退还本月已扣除的分期金额（如果本月在分期范围内）
                        if (startMonth <= currentMonth) {
                            const startDate = new Date(startMonth + '-01');
                            const currentDate = new Date(currentMonth + '-01');
                            const monthsDiff = (currentDate.getFullYear() - startDate.getFullYear()) * 12 + 
                                             (currentDate.getMonth() - startDate.getMonth());
                            const periods = Number(installmentData.periods || 0);
                            
                            // 如果本月在分期范围内，退还本月已扣金额
                            if (monthsDiff >= 0 && monthsDiff < periods) {
                                refundAmount = monthlyPayment;
                            }
                        }
                    }
                } else {
                    const { data: expenseData } = await supabaseClient
                        .from('expenses')
                        .select('amount')
                        .eq('id', id)
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    refundAmount = expenseData ? Number(expenseData.amount || 0) : 0;
                }

                // 删除交易
                const table = type === 'installment' ? 'installments' : 'expenses';
                const { error } = await supabaseClient
                    .from(table)
                    .delete()
                    .eq('id', id)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                // 退还资产
                if (refundAmount > 0) {
                    const { data: assetsData } = await supabaseClient
                        .from('assets')
                        .select('total_assets')
                        .eq('user_id', currentUser.id)
                        .maybeSingle();
                    
                    const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                    
                    await supabaseClient
                        .from('assets')
                        .upsert({
                            user_id: currentUser.id,
                            total_assets: currentAssets + refundAmount,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id'
                        });
                }

                showNotification('交易已刪除，已退還 ' + formatCurrency(refundAmount), 'success');

                // 重新加载数据
                await loadTotalAssets();
                await updateMonthlySummaryAndList();
                await updateExpenseChart();
                
                // 如果日期详情模态框是打开的，刷新其内容
                const dateModal = document.getElementById('date-detail-modal');
                if (!dateModal.classList.contains('hidden')) {
                    const dateTitle = document.getElementById('date-detail-title').textContent;
                    const dateMatch = dateTitle.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
                    if (dateMatch) {
                        const year = dateMatch[1];
                        const month = String(dateMatch[2]).padStart(2, '0');
                        const day = String(dateMatch[3]).padStart(2, '0');
                        const dateStr = `${year}-${month}-${day}`;
                        const dayTransactions = allTransactions.filter(tx => tx.date === dateStr);
                        renderDateTransactionList(dayTransactions, dateStr);
                    }
                }
            } catch (error) {
                console.error('刪除交易失敗:', error);
                showNotification('刪除失敗: ' + error.message, 'error');
            }
        };

        // 编辑交易的全局变量
        let editingTransaction = null;

        // 打开编辑模态框
        window.editTransaction = function(id, type, currentAmount, currentCategory, periods, startMonth) {
            // 保存当前编辑的交易信息
            editingTransaction = {
                id: id,
                type: type,
                currentAmount: currentAmount,
                currentCategory: currentCategory,
                periods: periods || 0,
                startMonth: startMonth || ''
            };

            // 根据类型显示/隐藏表单字段
            const expenseFields = document.getElementById('edit-expense-fields');
            const installmentFields = document.getElementById('edit-installment-fields');

            if (type === 'installment') {
                // 显示分期表单
                expenseFields.classList.add('hidden');
                installmentFields.classList.remove('hidden');
                
                // 填充分期表单
                document.getElementById('edit-total-amount').value = currentAmount;
                document.getElementById('edit-periods').value = periods;
                document.getElementById('edit-start-month').value = startMonth;
            } else {
                // 显示日常支出表单
                expenseFields.classList.remove('hidden');
                installmentFields.classList.add('hidden');
                
                // 填充支出表单
                document.getElementById('edit-amount').value = currentAmount;
            }

            // 填充类别（两种表单共用）
            document.getElementById('edit-category').value = currentCategory;

            // 显示模态框
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        // 取消编辑
        window.cancelEdit = function() {
            document.getElementById('edit-modal').classList.add('hidden');
            editingTransaction = null;
            
            // 清空所有表单字段
            document.getElementById('edit-amount').value = '';
            document.getElementById('edit-total-amount').value = '';
            document.getElementById('edit-periods').value = '';
            document.getElementById('edit-start-month').value = '';
        };

        // 确认编辑
        window.confirmEdit = async function() {
            if (!editingTransaction) return;

            const { id, type, currentAmount } = editingTransaction;
            const newCategory = document.getElementById('edit-category').value;
            const table = type === 'installment' ? 'installments' : 'expenses';

            try {
                if (type === 'expense') {
                    // 日常支出编辑
                    const amount = Number(document.getElementById('edit-amount').value);

                    if (isNaN(amount) || amount <= 0) {
                        showNotification('請輸入有效的金額', 'error');
                        return;
                    }

                    const { error } = await supabaseClient
                        .from(table)
                        .update({
                            amount: amount,
                            category: newCategory
                        })
                        .eq('id', id)
                        .eq('user_id', currentUser.id);

                    if (error) throw error;

                    // 更新总资产（调整差额）
                    const difference = Number(currentAmount) - amount;
                    const { data: assetsData } = await supabaseClient
                        .from('assets')
                        .select('total_assets')
                        .eq('user_id', currentUser.id)
                        .maybeSingle();
                    
                    const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                    
                    await supabaseClient
                        .from('assets')
                        .upsert({
                            user_id: currentUser.id,
                            total_assets: Math.max(0, currentAssets + difference),
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id'
                        });
                } else {
                    // 分期计划编辑
                    const totalAmount = Number(document.getElementById('edit-total-amount').value);
                    const periods = Number(document.getElementById('edit-periods').value);
                    const startMonth = document.getElementById('edit-start-month').value;

                    if (isNaN(totalAmount) || totalAmount <= 0) {
                        showNotification('請輸入有效的總額', 'error');
                        return;
                    }

                    if (isNaN(periods) || periods < 1) {
                        showNotification('期數至少為 1', 'error');
                        return;
                    }

                    if (!startMonth) {
                        showNotification('請選擇開始月份', 'error');
                        return;
                    }

                    const monthlyPayment = totalAmount / periods;
                    
                    // 先获取旧的分期计划信息
                    const { data: oldInstallmentData } = await supabaseClient
                        .from('installments')
                        .select('periods, start_month, monthly_payment')
                        .eq('id', id)
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    const { error } = await supabaseClient
                        .from(table)
                        .update({
                            total_amount: totalAmount,
                            periods: periods,
                            start_month: startMonth,
                            monthly_payment: monthlyPayment,
                            category: newCategory
                        })
                        .eq('id', id)
                        .eq('user_id', currentUser.id);

                    if (error) throw error;

                    // 计算新旧分期在本月应还金额的差异
                    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                    let oldMonthlyPayment = 0;
                    let newMonthlyPayment = 0;
                    
                    // 计算旧分期在本月的应还金额
                    if (oldInstallmentData && oldInstallmentData.start_month <= currentMonth) {
                        const oldStartDate = new Date(oldInstallmentData.start_month + '-01');
                        const currentDate = new Date(currentMonth + '-01');
                        const monthsDiff = (currentDate.getFullYear() - oldStartDate.getFullYear()) * 12 + 
                                         (currentDate.getMonth() - oldStartDate.getMonth());
                        const oldPeriods = Number(oldInstallmentData.periods || 0);
                        
                        if (monthsDiff >= 0 && monthsDiff < oldPeriods) {
                            oldMonthlyPayment = Number(oldInstallmentData.monthly_payment || 0);
                        }
                    }
                    
                    // 计算新分期在本月的应还金额
                    if (startMonth <= currentMonth) {
                        const newStartDate = new Date(startMonth + '-01');
                        const currentDate = new Date(currentMonth + '-01');
                        const monthsDiff = (currentDate.getFullYear() - newStartDate.getFullYear()) * 12 + 
                                         (currentDate.getMonth() - newStartDate.getMonth());
                        
                        if (monthsDiff >= 0 && monthsDiff < periods) {
                            newMonthlyPayment = monthlyPayment;
                        }
                    }
                    
                    // 计算本月金额差异（退还旧的，扣除新的）
                    const difference = oldMonthlyPayment - newMonthlyPayment;
                    
                    // 只有差异不为0时才更新总资产
                    if (difference !== 0) {
                        const { data: assetsData } = await supabaseClient
                            .from('assets')
                            .select('total_assets')
                            .eq('user_id', currentUser.id)
                            .maybeSingle();
                        
                        const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                        
                        await supabaseClient
                            .from('assets')
                            .upsert({
                                user_id: currentUser.id,
                                total_assets: Math.max(0, currentAssets + difference),
                                updated_at: new Date().toISOString()
                            }, {
                                onConflict: 'user_id'
                            });
                    }
                }

                // 关闭模态框
                document.getElementById('edit-modal').classList.add('hidden');
                editingTransaction = null;
                cancelEdit(); // 清空表单

                showNotification('交易已更新', 'success');
                
                // 重新加载数据
                await loadTotalAssets();
                await updateMonthlySummaryAndList();
                await updateExpenseChart();
                
                // 如果日期详情模态框是打开的，刷新其内容
                const dateModal = document.getElementById('date-detail-modal');
                if (!dateModal.classList.contains('hidden')) {
                    const dateTitle = document.getElementById('date-detail-title').textContent;
                    const dateMatch = dateTitle.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
                    if (dateMatch) {
                        const year = dateMatch[1];
                        const month = String(dateMatch[2]).padStart(2, '0');
                        const day = String(dateMatch[3]).padStart(2, '0');
                        const dateStr = `${year}-${month}-${day}`;
                        const dayTransactions = allTransactions.filter(tx => tx.date === dateStr);
                        renderDateTransactionList(dayTransactions, dateStr);
                    }
                }
            } catch (error) {
                console.error('更新交易失敗:', error);
                showNotification('更新失敗: ' + error.message, 'error');
            }
        };

        // 渲染交易清單（按日期分组）
        function renderTransactionList(transactions) {
            const listContainer = document.getElementById('transaction-list');
            
            const sortedTransactions = transactions
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 100); // 增加显示数量以便分组

            if (sortedTransactions.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <p>尚無交易紀錄</p>
                    </div>
                `;
                return;
            }

            // 按日期分组
            const groupedByDate = {};
            sortedTransactions.forEach(tx => {
                const dateKey = tx.date; // 使用 YYYY-MM-DD 格式作为键
                if (!groupedByDate[dateKey]) {
                    groupedByDate[dateKey] = [];
                }
                groupedByDate[dateKey].push(tx);
            });

            // 获取所有日期并排序（最新的在前面）
            const dates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

            // 格式化日期显示
            function formatDateDisplay(dateStr) {
                const date = new Date(dateStr);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                // 重置时间为 00:00:00 以便比较日期
                today.setHours(0, 0, 0, 0);
                yesterday.setHours(0, 0, 0, 0);
                date.setHours(0, 0, 0, 0);
                
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                
                if (date.getTime() === today.getTime()) {
                    return `今天 (${dateStr})`;
                } else if (date.getTime() === yesterday.getTime()) {
                    return `昨天 (${dateStr})`;
                } else {
                    const weekday = weekdays[date.getDay()];
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    return `${month}月${day}日 星期${weekday} (${dateStr})`;
                }
            }

            // 渲染每个日期组
            listContainer.innerHTML = dates.map(dateKey => {
                const dayTransactions = groupedByDate[dateKey];
                
                // 计算当天总支出
                const dayTotal = dayTransactions.reduce((sum, tx) => sum + Number(tx.amount || 0), 0);
                
                // 渲染当天所有交易
                const transactionsHtml = dayTransactions.map(tx => {
                    const categoryIcon = getCategoryIcon(tx.category);
                    const typeLabel = tx.type === 'installment' ? '分期' : '支出';
                    const typeBadgeColor = tx.type === 'installment' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                    
                    // 编辑模式下显示编辑和删除按钮
                    const periods = tx.periods || 0;
                    const startMonth = tx.start_month || '';
                    const editButtons = isEditMode ? `
                        <div class="flex gap-2 mt-2">
                            <button 
                                onclick="editTransaction('${tx.id}', '${tx.type}', ${tx.amount}, '${tx.category}', ${periods}, '${startMonth}')"
                                class="flex-1 px-3 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
                            >
                                編輯
                            </button>
                            <button 
                                onclick="deleteTransaction('${tx.id}', '${tx.type}')"
                                class="flex-1 px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
                            >
                                刪除
                            </button>
                        </div>
                    ` : '';
                    
                    return `
                        <div class="bg-white rounded-2xl p-4 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-2xl">${categoryIcon}</span>
                                        <span class="text-sm font-medium text-gray-600">${tx.category}</span>
                                        <span class="text-xs px-2 py-1 rounded-full ${typeBadgeColor}">${typeLabel}</span>
                                    </div>
                                    <p class="text-gray-700 font-medium">${tx.description || '無描述'}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold text-red-500">-${formatCurrency(tx.amount)}</p>
                                </div>
                            </div>
                            ${editButtons}
                        </div>
                    `;
                }).join('');

                return `
                    <div class="mb-6">
                        <!-- 日期标题 -->
                        <div class="flex items-center justify-between mb-3 px-2">
                            <h3 class="text-lg font-bold text-teal-700 flex items-center gap-2">
                                <span>📅</span>
                                <span>${formatDateDisplay(dateKey)}</span>
                            </h3>
                            <span class="text-sm font-medium text-gray-500">
                                共 ${dayTransactions.length} 筆，總計 ${formatCurrency(dayTotal)}
                            </span>
                        </div>
                        <!-- 当天的所有交易 -->
                        <div class="space-y-3">
                            ${transactionsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // 圓餅圖功能
        // ============================================
        async function updateExpenseChart() {
            try {
                // 获取日常支出
                const { data: expenses, error: expenseError } = await supabaseClient
                    .from('expenses')
                    .select('category, amount')
                    .eq('user_id', currentUser.id);

                if (expenseError) throw expenseError;

                // 获取分期计划
                const { data: installments, error: installmentError } = await supabaseClient
                    .from('installments')
                    .select('category, total_amount')
                    .eq('user_id', currentUser.id);

                if (installmentError) throw installmentError;

                const categoryStats = {};
                const categoryColors = {
                    '餐飲': '#FF6384',
                    '交通': '#36A2EB',
                    '娛樂': '#FFCE56',
                    '購物': '#4BC0C0',
                    '其他': '#9966FF'
                };
                const categoryIcons = {
                    '餐飲': '🍽️',
                    '交通': '🚗',
                    '娛樂': '🎮',
                    '購物': '🛍️',
                    '其他': '📝'
                };

                // 统计日常支出
                expenses?.forEach(expense => {
                    const category = expense.category;
                    const amount = Number(expense.amount || 0);
                    
                    if (!categoryStats[category]) {
                        categoryStats[category] = 0;
                    }
                    categoryStats[category] += amount;
                });

                // 统计分期计划（使用总金额）
                installments?.forEach(installment => {
                    const category = installment.category;
                    const amount = Number(installment.total_amount || 0);
                    
                    if (!categoryStats[category]) {
                        categoryStats[category] = 0;
                    }
                    categoryStats[category] += amount;
                });

                const labels = Object.keys(categoryStats);
                const data = Object.values(categoryStats);
                const backgroundColor = labels.map(label => categoryColors[label] || '#999');
                const totalExpense = data.reduce((sum, val) => sum + val, 0);

                if (totalExpense === 0) {
                    const canvas = document.getElementById('expense-chart');
                    const ctx = canvas.getContext('2d');
                    
                    if (expenseChart) {
                        expenseChart.destroy();
                        expenseChart = null;
                    }
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '16px "Noto Sans TC"';
                    ctx.fillStyle = '#9CA3AF';
                    ctx.textAlign = 'center';
                    ctx.fillText('尚無支出數據', canvas.width / 2, canvas.height / 2);
                    
                    document.getElementById('chart-legend').innerHTML = '';
                    return;
                }

                if (expenseChart) {
                    expenseChart.destroy();
                }

                const ctx = document.getElementById('expense-chart').getContext('2d');
                expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColor,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const percentage = ((value / totalExpense) * 100).toFixed(1);
                                        return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                let legendHTML = '';
                labels.forEach((label, index) => {
                    const value = data[index];
                    const percentage = ((value / totalExpense) * 100).toFixed(1);
                    const color = backgroundColor[index];
                    const icon = categoryIcons[label] || '💰';
                    
                    legendHTML += `
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full" style="background-color: ${color}"></div>
                                <span>${icon} ${label}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-medium">${formatCurrency(value)}</span>
                                <span class="text-gray-500">(${percentage}%)</span>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('chart-legend').innerHTML = legendHTML;
            } catch (error) {
                console.error('更新圓餅圖失敗:', error);
            }
        }

        // ============================================
        // 工具函數
        // ============================================
        function formatCurrency(amount) {
            return '$' + new Intl.NumberFormat('zh-TW', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function getCategoryIcon(category) {
            const icons = {
                '餐飲': '🍽️',
                '交通': '🚗',
                '娛樂': '🎮',
                '購物': '🛍️',
                '其他': '📝'
            };
            return icons[category] || '💰';
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            notificationMessage.textContent = message;
            
            notification.className = 'fixed top-4 right-4 px-6 py-3 rounded-2xl shadow-lg transition-all duration-300 z-50';
            if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
            } else {
                notification.classList.add('bg-blue-500', 'text-white');
            }
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // ============================================
        // 新增支出模態框功能
        // ============================================
        
        // 显示新增支出模态框
        window.showAddExpenseModal = function() {
            const modal = document.getElementById('add-expense-modal');
            modal.classList.remove('hidden');
            
            // 重置表单并显示日常支出标签
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expense-date').value = today;
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-category').value = '餐飲';
            document.getElementById('expense-description').value = '';
            
            // 重置分期表单
            document.getElementById('installment-total').value = '';
            document.getElementById('installment-periods').value = '';
            document.getElementById('installment-start').value = '';
            document.getElementById('installment-category').value = '餐飲';
            document.getElementById('installment-description').value = '';
            
            // 切换到日常支出标签
            switchModalTab('expense');
        };
        
        // 关闭新增支出模态框
        window.closeAddExpenseModal = function() {
            document.getElementById('add-expense-modal').classList.add('hidden');
        };
        
        // 切换模态框标签
        window.switchModalTab = function(tab) {
            const expenseForm = document.getElementById('modal-form-expense');
            const installmentForm = document.getElementById('modal-form-installment');
            const expenseTab = document.getElementById('modal-tab-expense');
            const installmentTab = document.getElementById('modal-tab-installment');

            if (tab === 'expense') {
                // 重置分期計畫表單
                document.getElementById('installment-total').value = '';
                document.getElementById('installment-periods').value = '';
                document.getElementById('installment-start').value = '';
                document.getElementById('installment-category').value = '餐飲';
                document.getElementById('installment-description').value = '';
                
                // 顯示日常支出表單
                expenseForm.classList.remove('hidden');
                installmentForm.classList.add('hidden');
                expenseTab.classList.add('bg-teal-500', 'text-white');
                expenseTab.classList.remove('bg-gray-100', 'text-gray-600');
                installmentTab.classList.add('bg-gray-100', 'text-gray-600');
                installmentTab.classList.remove('bg-teal-500', 'text-white');
            } else {
                // 重置日常支出表單
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('expense-date').value = today;
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-category').value = '餐飲';
                document.getElementById('expense-description').value = '';
                
                // 顯示分期計畫表單
                expenseForm.classList.add('hidden');
                installmentForm.classList.remove('hidden');
                installmentTab.classList.add('bg-teal-500', 'text-white');
                installmentTab.classList.remove('bg-gray-100', 'text-gray-600');
                expenseTab.classList.add('bg-gray-100', 'text-gray-600');
                expenseTab.classList.remove('bg-teal-500', 'text-white');
            }
        };

        // ============================================
        // 啟動應用程式
        // ============================================
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>

