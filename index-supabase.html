<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼‘é–’é¢¨å€‹äººè¨˜å¸³æœ¬ (Supabase é›²ç«¯ç‰ˆ)</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 50%, #80cbc4 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #78a1a1 0%, #5a8585 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(120, 161, 161, 0.4);
        }

        .input-field {
            transition: all 0.3s ease;
            max-width: 100%;
        }

        .input-field:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(120, 161, 161, 0.2);
        }

        .scroll-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #78a1a1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #5a8585;
        }
        
        /* ä¿®å¤æ‰‹æœºä¸Šçš„æ—¥æœŸè¾“å…¥æ¡†æº¢å‡º */
        input[type="date"],
        input[type="month"] {
            min-width: 0;
            flex-shrink: 1;
        }
        
        /* ç¡®ä¿æ‰€æœ‰å†…å®¹ä¸ä¼šæº¢å‡º */
        .glass-card {
            max-width: 100%;
            overflow: hidden;
        }
        
        /* å¼ºåˆ¶æ‰€æœ‰å…ƒç´ ä¸æº¢å‡º */
        input, select, textarea, button {
            max-width: 100%;
        }
        
        /* æ ‡é¢˜å“åº”å¼ */
        h1 {
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* ä¸»å®¹å™¨ä¸æº¢å‡º */
        #main-content {
            max-width: 100%;
            overflow-x: hidden;
        }
    </style>
</head>
<body class="p-3 sm:p-4 md:p-8">
    <!-- é€šçŸ¥çµ„ä»¶ -->
    <div id="notification" class="hidden fixed top-4 right-4 px-6 py-3 rounded-2xl shadow-lg z-50">
        <p id="notification-message" class="font-medium"></p>
    </div>

    <!-- ç·¨è¼¯äº¤æ˜“æ¨¡æ…‹æ¡† -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) cancelEdit()">
        <div class="glass-card rounded-3xl p-6 sm:p-8 max-w-md w-full shadow-2xl">
            <h3 class="text-2xl font-bold text-teal-800 mb-6">ç·¨è¼¯äº¤æ˜“</h3>
            
            <div class="space-y-4">
                <!-- æ—¥å¸¸æ”¯å‡ºè¡¨å• -->
                <div id="edit-expense-fields">
                    <!-- é‡‘é¢è¾“å…¥ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é‡‘é¡</label>
                        <input 
                            type="number" 
                            id="edit-amount" 
                            placeholder="è¼¸å…¥é‡‘é¡"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            min="0"
                            step="1"
                        >
                    </div>
                </div>

                <!-- åˆ†æœŸè®¡åˆ’è¡¨å• -->
                <div id="edit-installment-fields" class="hidden">
                    <!-- æ€»é¢è¾“å…¥ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç¸½é¡</label>
                        <input 
                            type="number" 
                            id="edit-total-amount" 
                            placeholder="è¼¸å…¥ç¸½é¡"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            min="0"
                            step="1"
                        >
                    </div>

                    <!-- æœŸæ•°è¾“å…¥ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æœŸæ•¸</label>
                        <input 
                            type="number" 
                            id="edit-periods" 
                            placeholder="åˆ†å¹¾æœŸ"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            min="1"
                            step="1"
                        >
                    </div>

                    <!-- å¼€å§‹æœˆä»½è¾“å…¥ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æœˆä»½</label>
                        <input 
                            type="month" 
                            id="edit-start-month" 
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none cursor-pointer"
                            onclick="this.showPicker()"
                        >
                    </div>
                </div>

                <!-- ç±»åˆ«ä¸‹æ‹‰é€‰å•ï¼ˆä¸¤ç§è¡¨å•å…±ç”¨ï¼‰ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é¡åˆ¥</label>
                    <select 
                        id="edit-category"
                        class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                    >
                        <option value="é¤é£²">ğŸ½ï¸ é¤é£²</option>
                        <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                        <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
                        <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                    </select>
                </div>

                <!-- æŒ‰é’®ç»„ -->
                <div class="flex gap-3 mt-6">
                    <button 
                        onclick="cancelEdit()"
                        class="flex-1 py-3 px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-2xl font-medium transition-colors"
                    >
                        å–æ¶ˆ
                    </button>
                    <button 
                        onclick="confirmEdit()"
                        class="flex-1 btn-primary py-3 px-4 rounded-2xl text-white font-medium"
                    >
                        ç¢ºèª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-teal-600 mb-4"></div>
            <p class="text-teal-700 font-medium text-lg">é€£æ¥é›²ç«¯æ•¸æ“šåº«...</p>
        </div>
    </div>

    <!-- ç™»å…¥/è¨»å†Šç•Œé¢ -->
    <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-md">
            <!-- Logo å’Œæ¨™é¡Œ -->
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-teal-800 mb-2">ğŸ’°</h1>
                <h2 class="text-2xl md:text-3xl font-bold text-teal-800 mb-2">ä¼‘é–’é¢¨å€‹äººè¨˜å¸³æœ¬</h2>
                <p class="text-teal-600">è¼•é¬†ç®¡ç†æ‚¨çš„è²¡å‹™ï¼Œè¿½è¹¤æ¯ä¸€ç­†æ”¯å‡º</p>
            </div>

            <!-- ç™»å…¥/è¨»å†Šå¡ç‰‡ -->
            <div class="glass-card rounded-3xl p-6 sm:p-8 shadow-xl">
                <!-- æ¨™ç±¤åˆ‡æ› -->
                <div class="flex gap-2 mb-6">
                    <button 
                        id="tab-login"
                        onclick="switchAuthTab('login')"
                        class="flex-1 py-3 px-4 rounded-2xl font-medium transition-all bg-teal-500 text-white"
                    >
                        ç™»å…¥
                    </button>
                    <button 
                        id="tab-signup"
                        onclick="switchAuthTab('signup')"
                        class="flex-1 py-3 px-4 rounded-2xl font-medium transition-all bg-gray-100 text-gray-600"
                    >
                        è¨»å†Š
                    </button>
                </div>

                <!-- Google å¿«é€Ÿç™»å…¥ -->
                <button 
                    onclick="signInWithGoogle()"
                    class="w-full mb-6 py-3 px-4 bg-white border-2 border-gray-300 rounded-2xl font-medium text-gray-700 hover:bg-gray-50 transition-all flex items-center justify-center gap-3"
                >
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>
                </button>

                <div class="relative mb-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">æˆ–ä½¿ç”¨éƒµç®±</span>
                    </div>
                </div>

                <!-- ç™»å…¥è¡¨å–® -->
                <div id="form-login" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é›»å­éƒµä»¶</label>
                        <input 
                            type="email" 
                            id="login-email" 
                            placeholder="your@email.com"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            autocomplete="email"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç¢¼</label>
                        <input 
                            type="password" 
                            id="login-password" 
                            placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            autocomplete="current-password"
                        >
                    </div>
                    <button 
                        onclick="signInWithEmail()"
                        class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                    >
                        ç™»å…¥
                    </button>
                </div>

                <!-- è¨»å†Šè¡¨å–® -->
                <div id="form-signup" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é›»å­éƒµä»¶</label>
                        <input 
                            type="email" 
                            id="signup-email" 
                            placeholder="your@email.com"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            autocomplete="email"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç¢¼</label>
                        <input 
                            type="password" 
                            id="signup-password" 
                            placeholder="è‡³å°‘ 6 å€‹å­—ç¬¦"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            autocomplete="new-password"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç¢ºèªå¯†ç¢¼</label>
                        <input 
                            type="password" 
                            id="signup-password-confirm" 
                            placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            autocomplete="new-password"
                        >
                    </div>
                    <button 
                        onclick="signUpWithEmail()"
                        class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                    >
                        è¨»å†Š
                    </button>
                </div>
            </div>

            <!-- æç¤ºä¿¡æ¯ -->
            <p class="text-center text-sm text-teal-600 mt-6">
                ä½¿ç”¨ Google ç™»å…¥å¯å¿«é€Ÿé–‹å§‹ä½¿ç”¨ âš¡
            </p>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div id="main-content" class="hidden max-w-7xl mx-auto">
        <!-- æ¨™é¡Œ -->
        <header class="mb-6 sm:mb-8">
            <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-teal-700 font-medium" id="user-email">ç”¨æˆ¶</span>
                </div>
                <button 
                    onclick="signOut()"
                    class="px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors"
                >
                    ğŸšª ç™»å‡º
                </button>
            </div>
            <!-- ä¸»æ ‡é¢˜ -->
            <div class="text-center">
                <h1 class="text-2xl sm:text-3xl md:text-5xl font-bold text-teal-800 mb-2">ğŸ’° ä¼‘é–’é¢¨å€‹äººè¨˜å¸³æœ¬</h1>
                <p class="text-sm sm:text-base text-teal-600">è¼•é¬†ç®¡ç†æ‚¨çš„è²¡å‹™ï¼Œè¿½è¹¤æ¯ä¸€ç­†æ”¯å‡º</p>
                <p class="text-xs sm:text-sm text-teal-500 mt-2">â˜ï¸ Supabase é›²ç«¯ç‰ˆ</p>
            </div>
        </header>

        <!-- éŸ¿æ‡‰å¼ä½ˆå±€ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- å·¦å´ï¼šè³‡ç”¢ç¸½è¦½èˆ‡æœˆåº¦ç¸½è¦½ -->
            <div class="space-y-6">
                <!-- ç¸½è³‡ç”¢å¡ç‰‡ -->
                <div class="glass-card rounded-3xl p-6 sm:p-8 shadow-xl">
                    <!-- æ€»èµ„äº§æ ‡é¢˜å’Œå›¾æ ‡ï¼ˆå±…ä¸­æ”¾å¤§ï¼‰ -->
                    <div class="text-center mb-6">
                        <div class="flex items-center justify-center gap-3 mb-4">
                            <span class="text-5xl sm:text-6xl">ğŸ’</span>
                            <h2 class="text-3xl sm:text-4xl font-bold text-teal-800">ç¸½è³‡ç”¢</h2>
                        </div>
                        <p class="text-5xl sm:text-6xl font-bold text-teal-700 mb-8" id="total-assets">$0</p>
                    </div>
                    
                    <!-- æ–°å¢èµ„äº§æŒ‰é’® -->
                    <button 
                        onclick="promptAddAssets()"
                        class="btn-primary w-full py-4 rounded-2xl text-white font-medium text-lg"
                    >
                        â• æ–°å¢è³‡ç”¢
                    </button>
                </div>

                <!-- æœ¬æœˆæ”¯å‡ºé è¦½ -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>ğŸ“Š</span>
                        <span>æœ¬æœˆæ”¯å‡ºé è¦½</span>
                    </h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">ä¸€èˆ¬æ”¯å‡º</span>
                            <span class="font-bold text-red-500" id="monthly-expenses">$0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">åˆ†æœŸæ”¤æ</span>
                            <span class="font-bold text-purple-500" id="monthly-installments">$0</span>
                        </div>
                        <div class="border-t-2 border-teal-200 pt-3 flex justify-between items-center">
                            <span class="text-lg font-bold text-teal-800">æœ¬æœˆç¸½è¨ˆ</span>
                            <span class="text-2xl font-bold text-teal-700" id="monthly-total">$0</span>
                        </div>
                    </div>
                </div>

                <!-- æ”¯å‡ºé¡å‹çµ±è¨ˆ -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>ğŸ¥§</span>
                        <span>æ”¯å‡ºé¡å‹çµ±è¨ˆ</span>
                    </h2>
                    <div class="relative" style="height: 280px;">
                        <canvas id="expense-chart"></canvas>
                    </div>
                    <div id="chart-legend" class="mt-4 space-y-2">
                        <!-- åœ–ä¾‹å°‡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šæ“ä½œå€èˆ‡äº¤æ˜“ç´€éŒ„ -->
            <div class="space-y-6">
                <!-- æ“ä½œå€ï¼šæ–°å¢æ”¯å‡ºèˆ‡åˆ†æœŸ -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <!-- æ¨™ç±¤åˆ‡æ› -->
                    <div class="flex gap-2 mb-6">
                        <button 
                            id="tab-expense"
                            onclick="switchTab('expense')"
                            class="flex-1 py-3 px-4 rounded-2xl font-medium transition-all"
                        >
                            ğŸ“ æ–°å¢æ—¥å¸¸æ”¯å‡º
                        </button>
                        <button 
                            id="tab-installment"
                            onclick="switchTab('installment')"
                            class="flex-1 py-3 px-4 rounded-2xl font-medium transition-all"
                        >
                            ğŸ’³ æ–°å¢åˆ†æœŸè¨ˆç•«
                        </button>
                    </div>

                    <!-- æ–°å¢æ—¥å¸¸æ”¯å‡ºè¡¨å–® -->
                    <div id="form-expense" class="form-content">
                        <form class="space-y-4" onsubmit="event.preventDefault(); addExpense();">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label>
                                <input 
                                    type="date" 
                                    id="expense-date" 
                                    required
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é‡‘é¡</label>
                                <input 
                                    type="number" 
                                    id="expense-amount" 
                                    placeholder="è¼¸å…¥é‡‘é¡"
                                    required
                                    min="0"
                                    step="1"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é¡åˆ¥</label>
                                <select 
                                    id="expense-category"
                                    required
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                                    <option value="é¤é£²">ğŸ½ï¸ é¤é£²</option>
                                    <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                                    <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
                                    <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                                    <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æè¿°</label>
                                <input 
                                    type="text" 
                                    id="expense-description" 
                                    placeholder="é …ç›®æè¿°ï¼ˆé¸å¡«ï¼‰"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <button 
                                type="submit"
                                class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                            >
                                æ–°å¢æ”¯å‡º
                            </button>
                        </form>
                    </div>

                    <!-- æ–°å¢åˆ†æœŸè¨ˆç•«è¡¨å–® -->
                    <div id="form-installment" class="form-content hidden">
                        <form class="space-y-4" onsubmit="event.preventDefault(); addInstallment();">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ç¸½é¡</label>
                                <input 
                                    type="number" 
                                    id="installment-total" 
                                    placeholder="è¼¸å…¥ç¸½é‡‘é¡"
                                    min="0"
                                    step="1"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æœŸæ•¸</label>
                                <input 
                                    type="number" 
                                    id="installment-periods" 
                                    placeholder="åˆ†å¹¾æœŸ"
                                    min="1"
                                    step="1"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æœˆä»½</label>
                                <input 
                                    type="month" 
                                    id="installment-start" 
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none cursor-pointer"
                                    onclick="this.showPicker()"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é¡åˆ¥</label>
                                <select 
                                    id="installment-category"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                                    <option value="é¤é£²">ğŸ½ï¸ é¤é£²</option>
                                    <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                                    <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
                                    <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                                    <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æè¿°</label>
                                <input 
                                    type="text" 
                                    id="installment-description" 
                                    placeholder="é …ç›®æè¿°ï¼ˆé¸å¡«ï¼‰"
                                    class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <button 
                                type="submit"
                                class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                            >
                                æ–°å¢åˆ†æœŸè¨ˆç•«
                            </button>
                        </form>
                    </div>
                </div>

                <!-- è¿‘æœŸäº¤æ˜“ç´€éŒ„ -->
                <div class="glass-card rounded-3xl p-4 sm:p-6 shadow-xl">
                    <div class="flex items-start justify-between mb-4">
                        <h2 class="text-xl font-bold text-teal-800 flex items-center gap-2">
                            <span>ğŸ“œ</span>
                            <span>è¿‘æœŸäº¤æ˜“ç´€éŒ„</span>
                        </h2>
                        <!-- ç¼–è¾‘æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
                        <button 
                            id="edit-mode-btn"
                            onclick="toggleEditMode()"
                            class="px-3 py-1 text-sm bg-teal-500 hover:bg-teal-600 text-white rounded-lg transition-colors"
                        >
                            âœï¸ ç·¨è¼¯
                        </button>
                        <button 
                            id="done-edit-btn"
                            onclick="toggleEditMode()"
                            class="hidden px-3 py-1 text-sm bg-gray-400 hover:bg-gray-500 text-white rounded-lg transition-colors"
                        >
                            âœ“ å®Œæˆ
                        </button>
                    </div>
                    <div id="transaction-list" class="scroll-container space-y-3">
                        <!-- äº¤æ˜“ç´€éŒ„å°‡å‹•æ…‹è¼‰å…¥ -->
                        <div class="text-center text-gray-400 py-8">
                            <p>è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é å°¾ -->
        <footer class="text-center mt-12 text-teal-600">
            <p class="text-sm">Â© 2025 ä¼‘é–’é¢¨å€‹äººè¨˜å¸³æœ¬ | è¼•é¬†ç®¡ç†ï¼Œç²¾å½©ç”Ÿæ´» âœ¨</p>
        </footer>
    </div>

    <script type="module">
        // ============================================
        // Supabase é…ç½®ï¼ˆè«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›å€¼ï¼‰
        // ============================================
        const SUPABASE_URL = 'https://cgptfjacrtbzcilkzusq.supabase.co';  // æ›¿æ›ç‚ºæ‚¨çš„ Supabase Project URL
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNncHRmamFjcnRiemNpbGt6dXNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MjUyNTcsImV4cCI6MjA3NzQwMTI1N30.vuoJpoV6zcVWnzBHxFJue3QawoPj7tPe0vk3w0hjTgs';  // æ›¿æ›ç‚ºæ‚¨çš„ anon public key

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================
        // å…¨åŸŸè®Šæ•¸
        // ============================================
        let expenseChart = null;
        let currentUser = null;

        // ============================================
        // èªè­‰èˆ‡åˆå§‹åŒ–
        // ============================================
        
        // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ ‡ç­¾
        window.switchAuthTab = function(tab) {
            const loginTab = document.getElementById('tab-login');
            const signupTab = document.getElementById('tab-signup');
            const loginForm = document.getElementById('form-login');
            const signupForm = document.getElementById('form-signup');

            if (tab === 'login') {
                loginTab.classList.add('bg-teal-500', 'text-white');
                loginTab.classList.remove('bg-gray-100', 'text-gray-600');
                signupTab.classList.remove('bg-teal-500', 'text-white');
                signupTab.classList.add('bg-gray-100', 'text-gray-600');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                signupTab.classList.add('bg-teal-500', 'text-white');
                signupTab.classList.remove('bg-gray-100', 'text-gray-600');
                loginTab.classList.remove('bg-teal-500', 'text-white');
                loginTab.classList.add('bg-gray-100', 'text-gray-600');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        };

        // Google ç™»å…¥
        window.signInWithGoogle = async function() {
            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + window.location.pathname
                    }
                });
                
                if (error) throw error;
                console.log('âœ“ æ­£åœ¨è·³è½‰åˆ° Google ç™»å…¥...');
            } catch (error) {
                console.error('Google ç™»å…¥å¤±æ•—:', error);
                showNotification('Google ç™»å…¥å¤±æ•—: ' + error.message, 'error');
            }
        };

        // éƒµç®±ç™»å…¥
        window.signInWithEmail = async function() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showNotification('è«‹è¼¸å…¥éƒµç®±å’Œå¯†ç¢¼', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentUser = data.user;
                console.log('âœ“ ç™»å…¥æˆåŠŸ:', currentUser.id);
                showNotification('ç™»å…¥æˆåŠŸï¼', 'success');
                
                // åˆå§‹åŒ–æ‡‰ç”¨
                await initializeMainApp();
            } catch (error) {
                console.error('ç™»å…¥å¤±æ•—:', error);
                showNotification('ç™»å…¥å¤±æ•—: ' + error.message, 'error');
            }
        };

        // éƒµç®±è¨»å†Š
        window.signUpWithEmail = async function() {
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const passwordConfirm = document.getElementById('signup-password-confirm').value;

            if (!email || !password || !passwordConfirm) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
                return;
            }

            if (password !== passwordConfirm) {
                showNotification('å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—ç¬¦', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        emailRedirectTo: window.location.origin + window.location.pathname
                    }
                });

                if (error) throw error;

                if (data.user) {
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦é‚®ç®±éªŒè¯
                    if (data.user.identities && data.user.identities.length === 0) {
                        showNotification('æ­¤éƒµç®±å·²è¢«è¨»å†Šï¼Œè«‹ç›´æ¥ç™»å…¥', 'error');
                        switchAuthTab('login');
                        document.getElementById('login-email').value = email;
                    } else {
                        showNotification('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥æ‚¨çš„éƒµç®±é€²è¡Œé©—è­‰ï¼ˆå¦‚éœ€è¦ï¼‰', 'success');
                        // æŸäº›é…ç½®ä¸‹å¯èƒ½ä¼šè‡ªåŠ¨ç™»å½•
                        if (data.session) {
                            currentUser = data.user;
                            await initializeMainApp();
                        } else {
                            // åˆ‡æ¢åˆ°ç™»å½•ç•Œé¢
                            setTimeout(() => {
                                switchAuthTab('login');
                                document.getElementById('login-email').value = email;
                            }, 2000);
                        }
                    }
                }
            } catch (error) {
                console.error('è¨»å†Šå¤±æ•—:', error);
                showNotification('è¨»å†Šå¤±æ•—: ' + error.message, 'error');
            }
        };

        // ç™»å‡º
        window.signOut = async function() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;

                console.log('âœ“ å·²ç™»å‡º');
                showNotification('å·²ç™»å‡º', 'success');
                
                // æ¸…ç©ºç”¨æˆ·ä¿¡æ¯
                currentUser = null;
                
                // æ˜¾ç¤ºç™»å½•ç•Œé¢
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            } catch (error) {
                console.error('ç™»å‡ºå¤±æ•—:', error);
                showNotification('ç™»å‡ºå¤±æ•—: ' + error.message, 'error');
            }
        };

        // åˆå§‹åŒ–ä¸»åº”ç”¨
        async function initializeMainApp() {
            try {
                // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                const userEmailElement = document.getElementById('user-email');
                if (currentUser.email) {
                    userEmailElement.textContent = currentUser.email;
                } else if (currentUser.user_metadata && currentUser.user_metadata.full_name) {
                    userEmailElement.textContent = currentUser.user_metadata.full_name;
                } else {
                    userEmailElement.textContent = 'ç”¨æˆ¶ ' + currentUser.id.substring(0, 8);
                }

                // è¨­ç½®é»˜èªæ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('expense-date').value = today;
                
                // è¨­ç½®é»˜èªæ¨™ç±¤æ¨£å¼
                switchTab('expense');
                
                // è¼‰å…¥æ•¸æ“š
                await loadTotalAssets();
                await updateMonthlySummaryAndList();
                await updateExpenseChart();
                
                // é¡¯ç¤ºä¸»è¦å…§å®¹
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                console.log('âœ“ æ‡‰ç”¨ç¨‹å¼å·²å•Ÿå‹•');
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                showNotification('åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function initializeApp() {
            try {
                // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                if (user) {
                    currentUser = user;
                    console.log('âœ“ ç”¨æˆ¶å·²ç™»å…¥:', user.id);
                    await initializeMainApp();
                } else {
                    // æ˜¾ç¤ºç™»å½•ç•Œé¢
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('auth-screen').classList.remove('hidden');
                    console.log('è¯·ç™»å…¥');
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        }

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth event:', event);
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                console.log('âœ“ ç”¨æˆ¶å·²ç™»å…¥:', currentUser.id);
                initializeMainApp();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        // ============================================
        // ç¸½è³‡ç”¢ç®¡ç†
        // ============================================
        async function loadTotalAssets() {
            try {
                const { data, error } = await supabaseClient
                    .from('assets')
                    .select('total_assets')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤º 0
                const totalAssets = data ? Number(data.total_assets || 0) : 0;
                document.getElementById('total-assets').textContent = formatCurrency(totalAssets);
                
                console.log('ğŸ’° æ€»èµ„äº§:', totalAssets);
            } catch (error) {
                console.error('è¼‰å…¥ç¸½è³‡ç”¢å¤±æ•—:', error);
                document.getElementById('total-assets').textContent = formatCurrency(0);
            }
        }

        // åˆ‡æ¢ç¼–è¾‘æ€»èµ„äº§åŒºåŸŸ
        // å¼¹å‡ºè¾“å…¥æ¡†æ–°å¢èµ„äº§
        window.promptAddAssets = async function() {
            const inputAmount = prompt('è«‹è¼¸å…¥è¦æ–°å¢çš„é‡‘é¡ï¼ˆå¯è¼¸å…¥è² æ•¸ä¾†æ‰£é™¤ï¼‰:');
            
            if (inputAmount === null) return; // ç”¨æˆ·å–æ¶ˆ
            
            const addAmount = Number(inputAmount);

            if (isNaN(addAmount) || addAmount === 0) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡', 'error');
                return;
            }

            try {
                // ç²å–ç•¶å‰ç¸½è³‡ç”¢
                const { data: assetsData } = await supabaseClient
                    .from('assets')
                    .select('total_assets')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                const newAssets = Math.max(0, currentAssets + addAmount);

                // æ›´æ–°ç¸½è³‡ç”¢
                const { error } = await supabaseClient
                    .from('assets')
                    .upsert({
                        user_id: currentUser.id,
                        total_assets: newAssets,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) throw error;

                console.log('âœ… èµ„äº§å·²æ–°å¢:', addAmount, 'æ–°æ€»èµ„äº§:', newAssets);
                await loadTotalAssets();
                
                if (addAmount > 0) {
                    showNotification(`å·²æ–°å¢ ${formatCurrency(addAmount)}ï¼Œç¸½è³‡ç”¢ç¾ç‚º ${formatCurrency(newAssets)}`, 'success');
                } else {
                    showNotification(`å·²æ‰£é™¤ ${formatCurrency(Math.abs(addAmount))}ï¼Œç¸½è³‡ç”¢ç¾ç‚º ${formatCurrency(newAssets)}`, 'success');
                }
            } catch (error) {
                console.error('æ–°å¢è³‡ç”¢å¤±æ•—:', error);
                showNotification(`æ“ä½œå¤±æ•—: ${error.message}`, 'error');
            }
        };

        // ============================================
        // æ—¥å¸¸æ”¯å‡ºè¨˜éŒ„
        // ============================================
        window.addExpense = async function() {
            const date = document.getElementById('expense-date').value;
            const amount = Number(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value;

            if (!date || isNaN(amount) || amount <= 0 || !category) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }

            try {
                // æ–°å¢æ”¯å‡º
                const { error } = await supabaseClient
                    .from('expenses')
                    .insert({
                        user_id: currentUser.id,
                        date: date,
                        amount: amount,
                        category: category,
                        description: description || ''
                    });

                if (error) throw error;

                // è‡ªå‹•å¾ç¸½è³‡ç”¢æ‰£é™¤
                const { data: assetsData } = await supabaseClient
                    .from('assets')
                    .select('total_assets')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                const newAssets = Math.max(0, currentAssets - amount); // ä¸å…è®¸è´Ÿæ•°
                
                await supabaseClient
                    .from('assets')
                    .upsert({
                        user_id: currentUser.id,
                        total_assets: newAssets,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });

                await loadTotalAssets();
                showNotification(`æ”¯å‡ºå·²è¨˜éŒ„ï¼Œç¸½è³‡ç”¢å·²æ‰£é™¤ ${formatCurrency(amount)}`, 'success');
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-category').value = 'é¤é£²';
                document.getElementById('expense-description').value = '';

                // æ›´æ–°é¡¯ç¤º
                await updateMonthlySummaryAndList();
                await updateExpenseChart();
            } catch (error) {
                console.error('æ–°å¢æ”¯å‡ºå¤±æ•—:', error);
                showNotification('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        };

        // ============================================
        // ä¿¡ç”¨å¡åˆ†æœŸè¿½è¹¤
        // ============================================
        window.addInstallment = async function() {
            const totalAmount = Number(document.getElementById('installment-total').value);
            const periods = Number(document.getElementById('installment-periods').value);
            const startMonth = document.getElementById('installment-start').value;
            const category = document.getElementById('installment-category').value;
            const description = document.getElementById('installment-description').value;

            if (isNaN(totalAmount) || totalAmount <= 0) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¸½é¡', 'error');
                return;
            }
            if (isNaN(periods) || periods <= 0 || !Number.isInteger(periods)) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„æœŸæ•¸ï¼ˆæ­£æ•´æ•¸ï¼‰', 'error');
                return;
            }
            if (!startMonth || !category) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }

            const monthlyPayment = totalAmount / periods;

            try {
                // æ–°å¢åˆ†æœŸè¨ˆç•«
                const { error } = await supabaseClient
                    .from('installments')
                    .insert({
                        user_id: currentUser.id,
                        total_amount: totalAmount,
                        periods: periods,
                        start_month: startMonth,
                        category: category,
                        description: description || '',
                        monthly_payment: monthlyPayment
                    });

                if (error) throw error;

                // æª¢æŸ¥ç•¶å‰æœˆä»½æ˜¯å¦éœ€è¦æ‰£é™¤åˆ†æœŸé‡‘é¡
                // âš ï¸ é‡è¦ï¼šåªæ‰£é™¤ç•¶æœˆåˆ†æœŸæ”¤æé‡‘é¡ï¼Œä¸æ˜¯ç¸½é¡ï¼
                const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                let deductAmount = 0;
                let notificationMessage = 'åˆ†æœŸè¨ˆç•«å·²æ–°å¢';

                console.log('ğŸ“‹ åˆ†æœŸè¨ˆåŠƒè³‡è¨Š:', {
                    totalAmount,
                    periods,
                    monthlyPayment,
                    startMonth,
                    currentMonth
                });

                // å¦‚æœç•¶å‰æœˆä»½åœ¨åˆ†æœŸç¯„åœå…§ï¼Œæ‰£é™¤ç•¶æœˆæ‡‰é‚„é‡‘é¡ï¼ˆä¸æ˜¯ç¸½é¡ï¼ï¼‰
                if (startMonth <= currentMonth) {
                    // è¨ˆç®—ç•¶å‰æœˆä»½æ˜¯ç¬¬å¹¾æœŸ
                    const startDate = new Date(startMonth + '-01');
                    const currentDate = new Date(currentMonth + '-01');
                    const monthsDiff = (currentDate.getFullYear() - startDate.getFullYear()) * 12 + 
                                     (currentDate.getMonth() - startDate.getMonth());
                    
                    console.log('ğŸ“… æœˆä»½è¨ˆç®—:', {
                        startMonth,
                        currentMonth,
                        monthsDiff,
                        periods
                    });
                    
                    // å¦‚æœé‚„åœ¨åˆ†æœŸæœŸæ•¸å…§ï¼Œæ‰£é™¤ç•¶æœˆé‡‘é¡ï¼ˆmonthlyPaymentï¼Œä¸æ˜¯totalAmountï¼ï¼‰
                    if (monthsDiff >= 0 && monthsDiff < periods) {
                        deductAmount = monthlyPayment; // âœ… åªæ‰£é™¤ç•¶æœˆæ”¤æ
                        console.log('âœ… æ‰£é™¤ç•¶æœˆåˆ†æœŸé‡‘é¡:', deductAmount, '(ä¸æ˜¯ç¸½é¡', totalAmount, ')');
                    } else {
                        console.log('âš ï¸ ç•¶å‰æœˆä»½ä¸åœ¨åˆ†æœŸç¯„åœå…§');
                    }
                } else {
                    console.log('â° åˆ†æœŸå°šæœªé–‹å§‹ï¼Œä¸æ‰£é™¤');
                }

                // âš ï¸ åªæ‰£é™¤ç•¶æœˆåˆ†æœŸé‡‘é¡ï¼Œä¸æ˜¯ç¸½é¡ï¼
                if (deductAmount > 0) {
                    const { data: assetsData } = await supabaseClient
                        .from('assets')
                        .select('total_assets')
                        .eq('user_id', currentUser.id)
                        .maybeSingle();

                    const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                    const newAssets = Math.max(0, currentAssets - deductAmount); // âœ… åªæ‰£é™¤ deductAmount
                    
                    console.log('ğŸ’° ç¸½è³‡ç”¢èª¿æ•´:', {
                        currentAssets,
                        deductAmount,
                        newAssets
                    });
                    
                    await supabaseClient
                        .from('assets')
                        .upsert({
                            user_id: currentUser.id,
                            total_assets: newAssets,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id'
                        });

                    notificationMessage += `ï¼Œæœ¬æœˆå·²æ‰£é™¤ ${formatCurrency(deductAmount)}`;
                } else if (startMonth > currentMonth) {
                    notificationMessage += 'ï¼ˆå°šæœªé–‹å§‹æ‰£æ¬¾ï¼‰';
                }

                await loadTotalAssets();
                showNotification(notificationMessage, 'success');
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('installment-total').value = '';
                document.getElementById('installment-periods').value = '';
                document.getElementById('installment-start').value = '';
                document.getElementById('installment-category').value = 'é¤é£²';
                document.getElementById('installment-description').value = '';

                // æ›´æ–°é¡¯ç¤º
                await updateMonthlySummaryAndList();
            } catch (error) {
                console.error('æ–°å¢åˆ†æœŸè¨ˆç•«å¤±æ•—:', error);
                showNotification('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        };

        // ============================================
        // æœˆåº¦ç¸½è¦½èˆ‡äº¤æ˜“æ¸…å–®
        // ============================================
        async function updateMonthlySummaryAndList() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            let monthlyExpenses = 0;
            let monthlyInstallments = 0;
            const transactionList = [];

            try {
                // ç²å–æ—¥å¸¸æ”¯å‡º
                const { data: expenses, error: expensesError } = await supabaseClient
                    .from('expenses')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (expensesError) throw expensesError;

                expenses?.forEach(expense => {
                    const expenseMonth = expense.date.slice(0, 7);
                    const amount = Number(expense.amount || 0);
                    
                    if (expenseMonth === currentMonth) {
                        monthlyExpenses += amount;
                    }
                    
                    transactionList.push({
                        id: expense.id,
                        type: 'expense',
                        date: expense.date,
                        amount: amount,
                        category: expense.category,
                        description: expense.description,
                        timestamp: new Date(expense.created_at).getTime()
                    });
                });

                // ç²å–åˆ†æœŸè¨ˆç•«
                const { data: installments, error: installmentsError } = await supabaseClient
                    .from('installments')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (installmentsError) throw installmentsError;

                installments?.forEach(installment => {
                    const totalAmount = Number(installment.total_amount || 0);
                    const periods = Number(installment.periods || 1);
                    const startMonth = installment.start_month;
                    const monthlyPayment = Number(installment.monthly_payment || (totalAmount / periods));
                    
                    if (isMonthInInstallmentRange(currentMonth, startMonth, periods)) {
                        monthlyInstallments += monthlyPayment;
                        
                        transactionList.push({
                            id: installment.id,
                            type: 'installment',
                            date: currentMonth + '-01',
                            amount: monthlyPayment,
                            category: installment.category,
                            description: `${installment.description} (åˆ†æœŸ ${periods} æœŸ)`,
                            timestamp: new Date(installment.created_at).getTime()
                        });
                    }
                });

                // æ›´æ–°å„€è¡¨æ¿
                document.getElementById('monthly-expenses').textContent = formatCurrency(monthlyExpenses);
                document.getElementById('monthly-installments').textContent = formatCurrency(monthlyInstallments);
                document.getElementById('monthly-total').textContent = formatCurrency(monthlyExpenses + monthlyInstallments);
                
                // æ¸²æŸ“äº¤æ˜“æ¸…å–®
                renderTransactionList(transactionList);
            } catch (error) {
                console.error('æ›´æ–°æœˆåº¦ç¸½è¦½å¤±æ•—:', error);
            }
        }

        // æª¢æŸ¥æœˆä»½æ˜¯å¦åœ¨åˆ†æœŸç¯„åœå…§
        function isMonthInInstallmentRange(currentMonth, startMonth, periods) {
            const current = new Date(currentMonth + '-01');
            const start = new Date(startMonth + '-01');
            const end = new Date(start);
            end.setMonth(end.getMonth() + periods);
            
            return current >= start && current < end;
        }

        // å…¨å±€ç¼–è¾‘æ¨¡å¼çŠ¶æ€
        let isEditMode = false;

        // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
        window.toggleEditMode = function() {
            isEditMode = !isEditMode;
            const editBtn = document.getElementById('edit-mode-btn');
            const doneBtn = document.getElementById('done-edit-btn');
            
            if (isEditMode) {
                editBtn.classList.add('hidden');
                doneBtn.classList.remove('hidden');
            } else {
                editBtn.classList.remove('hidden');
                doneBtn.classList.add('hidden');
            }
            
            // é‡æ–°æ¸²æŸ“äº¤æ˜“åˆ—è¡¨
            updateMonthlySummaryAndList();
        };

        // åˆ é™¤äº¤æ˜“
        window.deleteTransaction = async function(id, type) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†äº¤æ˜“å—ï¼Ÿ')) {
                return;
            }

            try {
                let refundAmount = 0;
                
                // å…ˆè·å–è¦åˆ é™¤çš„æ•°æ®ï¼ˆç”¨äºé€€è¿˜èµ„äº§ï¼‰
                if (type === 'installment') {
                    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                    const { data: installmentData } = await supabaseClient
                        .from('installments')
                        .select('total_amount, periods, start_month, monthly_payment')
                        .eq('id', id)
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    if (installmentData) {
                        const startMonth = installmentData.start_month;
                        const monthlyPayment = Number(installmentData.monthly_payment || 0);
                        
                        // åªé€€è¿˜æœ¬æœˆå·²æ‰£é™¤çš„åˆ†æœŸé‡‘é¢ï¼ˆå¦‚æœæœ¬æœˆåœ¨åˆ†æœŸèŒƒå›´å†…ï¼‰
                        if (startMonth <= currentMonth) {
                            const startDate = new Date(startMonth + '-01');
                            const currentDate = new Date(currentMonth + '-01');
                            const monthsDiff = (currentDate.getFullYear() - startDate.getFullYear()) * 12 + 
                                             (currentDate.getMonth() - startDate.getMonth());
                            const periods = Number(installmentData.periods || 0);
                            
                            // å¦‚æœæœ¬æœˆåœ¨åˆ†æœŸèŒƒå›´å†…ï¼Œé€€è¿˜æœ¬æœˆå·²æ‰£é‡‘é¢
                            if (monthsDiff >= 0 && monthsDiff < periods) {
                                refundAmount = monthlyPayment;
                            }
                        }
                    }
                } else {
                    const { data: expenseData } = await supabaseClient
                        .from('expenses')
                        .select('amount')
                        .eq('id', id)
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    refundAmount = expenseData ? Number(expenseData.amount || 0) : 0;
                }

                // åˆ é™¤äº¤æ˜“
                const table = type === 'installment' ? 'installments' : 'expenses';
                const { error } = await supabaseClient
                    .from(table)
                    .delete()
                    .eq('id', id)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                // é€€è¿˜èµ„äº§
                if (refundAmount > 0) {
                    const { data: assetsData } = await supabaseClient
                        .from('assets')
                        .select('total_assets')
                        .eq('user_id', currentUser.id)
                        .maybeSingle();
                    
                    const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                    
                    await supabaseClient
                        .from('assets')
                        .upsert({
                            user_id: currentUser.id,
                            total_assets: currentAssets + refundAmount,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id'
                        });
                }

                showNotification('äº¤æ˜“å·²åˆªé™¤ï¼Œå·²é€€é‚„ ' + formatCurrency(refundAmount), 'success');

                // é‡æ–°åŠ è½½æ•°æ®
                await loadTotalAssets();
                await updateMonthlySummaryAndList();
                await updateExpenseChart();
            } catch (error) {
                console.error('åˆªé™¤äº¤æ˜“å¤±æ•—:', error);
                showNotification('åˆªé™¤å¤±æ•—: ' + error.message, 'error');
            }
        };

        // ç¼–è¾‘äº¤æ˜“çš„å…¨å±€å˜é‡
        let editingTransaction = null;

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        window.editTransaction = function(id, type, currentAmount, currentCategory, periods, startMonth) {
            // ä¿å­˜å½“å‰ç¼–è¾‘çš„äº¤æ˜“ä¿¡æ¯
            editingTransaction = {
                id: id,
                type: type,
                currentAmount: currentAmount,
                currentCategory: currentCategory,
                periods: periods || 0,
                startMonth: startMonth || ''
            };

            // æ ¹æ®ç±»å‹æ˜¾ç¤º/éšè—è¡¨å•å­—æ®µ
            const expenseFields = document.getElementById('edit-expense-fields');
            const installmentFields = document.getElementById('edit-installment-fields');

            if (type === 'installment') {
                // æ˜¾ç¤ºåˆ†æœŸè¡¨å•
                expenseFields.classList.add('hidden');
                installmentFields.classList.remove('hidden');
                
                // å¡«å……åˆ†æœŸè¡¨å•
                document.getElementById('edit-total-amount').value = currentAmount;
                document.getElementById('edit-periods').value = periods;
                document.getElementById('edit-start-month').value = startMonth;
            } else {
                // æ˜¾ç¤ºæ—¥å¸¸æ”¯å‡ºè¡¨å•
                expenseFields.classList.remove('hidden');
                installmentFields.classList.add('hidden');
                
                // å¡«å……æ”¯å‡ºè¡¨å•
                document.getElementById('edit-amount').value = currentAmount;
            }

            // å¡«å……ç±»åˆ«ï¼ˆä¸¤ç§è¡¨å•å…±ç”¨ï¼‰
            document.getElementById('edit-category').value = currentCategory;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        // å–æ¶ˆç¼–è¾‘
        window.cancelEdit = function() {
            document.getElementById('edit-modal').classList.add('hidden');
            editingTransaction = null;
            
            // æ¸…ç©ºæ‰€æœ‰è¡¨å•å­—æ®µ
            document.getElementById('edit-amount').value = '';
            document.getElementById('edit-total-amount').value = '';
            document.getElementById('edit-periods').value = '';
            document.getElementById('edit-start-month').value = '';
        };

        // ç¡®è®¤ç¼–è¾‘
        window.confirmEdit = async function() {
            if (!editingTransaction) return;

            const { id, type, currentAmount } = editingTransaction;
            const newCategory = document.getElementById('edit-category').value;
            const table = type === 'installment' ? 'installments' : 'expenses';

            try {
                if (type === 'expense') {
                    // æ—¥å¸¸æ”¯å‡ºç¼–è¾‘
                    const amount = Number(document.getElementById('edit-amount').value);

                    if (isNaN(amount) || amount <= 0) {
                        showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡', 'error');
                        return;
                    }

                    const { error } = await supabaseClient
                        .from(table)
                        .update({
                            amount: amount,
                            category: newCategory
                        })
                        .eq('id', id)
                        .eq('user_id', currentUser.id);

                    if (error) throw error;

                    // æ›´æ–°æ€»èµ„äº§ï¼ˆè°ƒæ•´å·®é¢ï¼‰
                    const difference = Number(currentAmount) - amount;
                    const { data: assetsData } = await supabaseClient
                        .from('assets')
                        .select('total_assets')
                        .eq('user_id', currentUser.id)
                        .maybeSingle();
                    
                    const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                    
                    await supabaseClient
                        .from('assets')
                        .upsert({
                            user_id: currentUser.id,
                            total_assets: Math.max(0, currentAssets + difference),
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id'
                        });
                } else {
                    // åˆ†æœŸè®¡åˆ’ç¼–è¾‘
                    const totalAmount = Number(document.getElementById('edit-total-amount').value);
                    const periods = Number(document.getElementById('edit-periods').value);
                    const startMonth = document.getElementById('edit-start-month').value;

                    if (isNaN(totalAmount) || totalAmount <= 0) {
                        showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¸½é¡', 'error');
                        return;
                    }

                    if (isNaN(periods) || periods < 1) {
                        showNotification('æœŸæ•¸è‡³å°‘ç‚º 1', 'error');
                        return;
                    }

                    if (!startMonth) {
                        showNotification('è«‹é¸æ“‡é–‹å§‹æœˆä»½', 'error');
                        return;
                    }

                    const monthlyPayment = totalAmount / periods;
                    
                    // å…ˆè·å–æ—§çš„åˆ†æœŸè®¡åˆ’ä¿¡æ¯
                    const { data: oldInstallmentData } = await supabaseClient
                        .from('installments')
                        .select('periods, start_month, monthly_payment')
                        .eq('id', id)
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    const { error } = await supabaseClient
                        .from(table)
                        .update({
                            total_amount: totalAmount,
                            periods: periods,
                            start_month: startMonth,
                            monthly_payment: monthlyPayment,
                            category: newCategory
                        })
                        .eq('id', id)
                        .eq('user_id', currentUser.id);

                    if (error) throw error;

                    // è®¡ç®—æ–°æ—§åˆ†æœŸåœ¨æœ¬æœˆåº”è¿˜é‡‘é¢çš„å·®å¼‚
                    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                    let oldMonthlyPayment = 0;
                    let newMonthlyPayment = 0;
                    
                    // è®¡ç®—æ—§åˆ†æœŸåœ¨æœ¬æœˆçš„åº”è¿˜é‡‘é¢
                    if (oldInstallmentData && oldInstallmentData.start_month <= currentMonth) {
                        const oldStartDate = new Date(oldInstallmentData.start_month + '-01');
                        const currentDate = new Date(currentMonth + '-01');
                        const monthsDiff = (currentDate.getFullYear() - oldStartDate.getFullYear()) * 12 + 
                                         (currentDate.getMonth() - oldStartDate.getMonth());
                        const oldPeriods = Number(oldInstallmentData.periods || 0);
                        
                        if (monthsDiff >= 0 && monthsDiff < oldPeriods) {
                            oldMonthlyPayment = Number(oldInstallmentData.monthly_payment || 0);
                        }
                    }
                    
                    // è®¡ç®—æ–°åˆ†æœŸåœ¨æœ¬æœˆçš„åº”è¿˜é‡‘é¢
                    if (startMonth <= currentMonth) {
                        const newStartDate = new Date(startMonth + '-01');
                        const currentDate = new Date(currentMonth + '-01');
                        const monthsDiff = (currentDate.getFullYear() - newStartDate.getFullYear()) * 12 + 
                                         (currentDate.getMonth() - newStartDate.getMonth());
                        
                        if (monthsDiff >= 0 && monthsDiff < periods) {
                            newMonthlyPayment = monthlyPayment;
                        }
                    }
                    
                    // è®¡ç®—æœ¬æœˆé‡‘é¢å·®å¼‚ï¼ˆé€€è¿˜æ—§çš„ï¼Œæ‰£é™¤æ–°çš„ï¼‰
                    const difference = oldMonthlyPayment - newMonthlyPayment;
                    
                    // åªæœ‰å·®å¼‚ä¸ä¸º0æ—¶æ‰æ›´æ–°æ€»èµ„äº§
                    if (difference !== 0) {
                        const { data: assetsData } = await supabaseClient
                            .from('assets')
                            .select('total_assets')
                            .eq('user_id', currentUser.id)
                            .maybeSingle();
                        
                        const currentAssets = assetsData ? Number(assetsData.total_assets || 0) : 0;
                        
                        await supabaseClient
                            .from('assets')
                            .upsert({
                                user_id: currentUser.id,
                                total_assets: Math.max(0, currentAssets + difference),
                                updated_at: new Date().toISOString()
                            }, {
                                onConflict: 'user_id'
                            });
                    }
                }

                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('edit-modal').classList.add('hidden');
                editingTransaction = null;
                cancelEdit(); // æ¸…ç©ºè¡¨å•

                showNotification('äº¤æ˜“å·²æ›´æ–°', 'success');
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadTotalAssets();
                await updateMonthlySummaryAndList();
                await updateExpenseChart();
            } catch (error) {
                console.error('æ›´æ–°äº¤æ˜“å¤±æ•—:', error);
                showNotification('æ›´æ–°å¤±æ•—: ' + error.message, 'error');
            }
        };

        // æ¸²æŸ“äº¤æ˜“æ¸…å–®ï¼ˆæŒ‰æ—¥æœŸåˆ†ç»„ï¼‰
        function renderTransactionList(transactions) {
            const listContainer = document.getElementById('transaction-list');
            
            const sortedTransactions = transactions
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 100); // å¢åŠ æ˜¾ç¤ºæ•°é‡ä»¥ä¾¿åˆ†ç»„

            if (sortedTransactions.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <p>å°šç„¡äº¤æ˜“ç´€éŒ„</p>
                    </div>
                `;
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„
            const groupedByDate = {};
            sortedTransactions.forEach(tx => {
                const dateKey = tx.date; // ä½¿ç”¨ YYYY-MM-DD æ ¼å¼ä½œä¸ºé”®
                if (!groupedByDate[dateKey]) {
                    groupedByDate[dateKey] = [];
                }
                groupedByDate[dateKey].push(tx);
            });

            // è·å–æ‰€æœ‰æ—¥æœŸå¹¶æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            const dates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

            // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
            function formatDateDisplay(dateStr) {
                const date = new Date(dateStr);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                // é‡ç½®æ—¶é—´ä¸º 00:00:00 ä»¥ä¾¿æ¯”è¾ƒæ—¥æœŸ
                today.setHours(0, 0, 0, 0);
                yesterday.setHours(0, 0, 0, 0);
                date.setHours(0, 0, 0, 0);
                
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                
                if (date.getTime() === today.getTime()) {
                    return `ä»Šå¤© (${dateStr})`;
                } else if (date.getTime() === yesterday.getTime()) {
                    return `æ˜¨å¤© (${dateStr})`;
                } else {
                    const weekday = weekdays[date.getDay()];
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    return `${month}æœˆ${day}æ—¥ æ˜ŸæœŸ${weekday} (${dateStr})`;
                }
            }

            // æ¸²æŸ“æ¯ä¸ªæ—¥æœŸç»„
            listContainer.innerHTML = dates.map(dateKey => {
                const dayTransactions = groupedByDate[dateKey];
                
                // è®¡ç®—å½“å¤©æ€»æ”¯å‡º
                const dayTotal = dayTransactions.reduce((sum, tx) => sum + Number(tx.amount || 0), 0);
                
                // æ¸²æŸ“å½“å¤©æ‰€æœ‰äº¤æ˜“
                const transactionsHtml = dayTransactions.map(tx => {
                    const categoryIcon = getCategoryIcon(tx.category);
                    const typeLabel = tx.type === 'installment' ? 'åˆ†æœŸ' : 'æ”¯å‡º';
                    const typeBadgeColor = tx.type === 'installment' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                    
                    // ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
                    const periods = tx.periods || 0;
                    const startMonth = tx.start_month || '';
                    const editButtons = isEditMode ? `
                        <div class="flex gap-2 mt-2">
                            <button 
                                onclick="editTransaction('${tx.id}', '${tx.type}', ${tx.amount}, '${tx.category}', ${periods}, '${startMonth}')"
                                class="flex-1 px-3 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
                            >
                                ç·¨è¼¯
                            </button>
                            <button 
                                onclick="deleteTransaction('${tx.id}', '${tx.type}')"
                                class="flex-1 px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    ` : '';
                    
                    return `
                        <div class="bg-white rounded-2xl p-4 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-2xl">${categoryIcon}</span>
                                        <span class="text-sm font-medium text-gray-600">${tx.category}</span>
                                        <span class="text-xs px-2 py-1 rounded-full ${typeBadgeColor}">${typeLabel}</span>
                                    </div>
                                    <p class="text-gray-700 font-medium">${tx.description || 'ç„¡æè¿°'}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold text-red-500">-${formatCurrency(tx.amount)}</p>
                                </div>
                            </div>
                            ${editButtons}
                        </div>
                    `;
                }).join('');

                return `
                    <div class="mb-6">
                        <!-- æ—¥æœŸæ ‡é¢˜ -->
                        <div class="flex items-center justify-between mb-3 px-2">
                            <h3 class="text-lg font-bold text-teal-700 flex items-center gap-2">
                                <span>ğŸ“…</span>
                                <span>${formatDateDisplay(dateKey)}</span>
                            </h3>
                            <span class="text-sm font-medium text-gray-500">
                                å…± ${dayTransactions.length} ç­†ï¼Œç¸½è¨ˆ ${formatCurrency(dayTotal)}
                            </span>
                        </div>
                        <!-- å½“å¤©çš„æ‰€æœ‰äº¤æ˜“ -->
                        <div class="space-y-3">
                            ${transactionsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // åœ“é¤…åœ–åŠŸèƒ½
        // ============================================
        async function updateExpenseChart() {
            try {
                // è·å–æ—¥å¸¸æ”¯å‡º
                const { data: expenses, error: expenseError } = await supabaseClient
                    .from('expenses')
                    .select('category, amount')
                    .eq('user_id', currentUser.id);

                if (expenseError) throw expenseError;

                // è·å–åˆ†æœŸè®¡åˆ’
                const { data: installments, error: installmentError } = await supabaseClient
                    .from('installments')
                    .select('category, total_amount')
                    .eq('user_id', currentUser.id);

                if (installmentError) throw installmentError;

                const categoryStats = {};
                const categoryColors = {
                    'é¤é£²': '#FF6384',
                    'äº¤é€š': '#36A2EB',
                    'å¨›æ¨‚': '#FFCE56',
                    'è³¼ç‰©': '#4BC0C0',
                    'å…¶ä»–': '#9966FF'
                };
                const categoryIcons = {
                    'é¤é£²': 'ğŸ½ï¸',
                    'äº¤é€š': 'ğŸš—',
                    'å¨›æ¨‚': 'ğŸ®',
                    'è³¼ç‰©': 'ğŸ›ï¸',
                    'å…¶ä»–': 'ğŸ“'
                };

                // ç»Ÿè®¡æ—¥å¸¸æ”¯å‡º
                expenses?.forEach(expense => {
                    const category = expense.category;
                    const amount = Number(expense.amount || 0);
                    
                    if (!categoryStats[category]) {
                        categoryStats[category] = 0;
                    }
                    categoryStats[category] += amount;
                });

                // ç»Ÿè®¡åˆ†æœŸè®¡åˆ’ï¼ˆä½¿ç”¨æ€»é‡‘é¢ï¼‰
                installments?.forEach(installment => {
                    const category = installment.category;
                    const amount = Number(installment.total_amount || 0);
                    
                    if (!categoryStats[category]) {
                        categoryStats[category] = 0;
                    }
                    categoryStats[category] += amount;
                });

                const labels = Object.keys(categoryStats);
                const data = Object.values(categoryStats);
                const backgroundColor = labels.map(label => categoryColors[label] || '#999');
                const totalExpense = data.reduce((sum, val) => sum + val, 0);

                if (totalExpense === 0) {
                    const canvas = document.getElementById('expense-chart');
                    const ctx = canvas.getContext('2d');
                    
                    if (expenseChart) {
                        expenseChart.destroy();
                        expenseChart = null;
                    }
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '16px "Noto Sans TC"';
                    ctx.fillStyle = '#9CA3AF';
                    ctx.textAlign = 'center';
                    ctx.fillText('å°šç„¡æ”¯å‡ºæ•¸æ“š', canvas.width / 2, canvas.height / 2);
                    
                    document.getElementById('chart-legend').innerHTML = '';
                    return;
                }

                if (expenseChart) {
                    expenseChart.destroy();
                }

                const ctx = document.getElementById('expense-chart').getContext('2d');
                expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColor,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const percentage = ((value / totalExpense) * 100).toFixed(1);
                                        return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                let legendHTML = '';
                labels.forEach((label, index) => {
                    const value = data[index];
                    const percentage = ((value / totalExpense) * 100).toFixed(1);
                    const color = backgroundColor[index];
                    const icon = categoryIcons[label] || 'ğŸ’°';
                    
                    legendHTML += `
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full" style="background-color: ${color}"></div>
                                <span>${icon} ${label}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-medium">${formatCurrency(value)}</span>
                                <span class="text-gray-500">(${percentage}%)</span>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('chart-legend').innerHTML = legendHTML;
            } catch (error) {
                console.error('æ›´æ–°åœ“é¤…åœ–å¤±æ•—:', error);
            }
        }

        // ============================================
        // å·¥å…·å‡½æ•¸
        // ============================================
        function formatCurrency(amount) {
            return '$' + new Intl.NumberFormat('zh-TW', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function getCategoryIcon(category) {
            const icons = {
                'é¤é£²': 'ğŸ½ï¸',
                'äº¤é€š': 'ğŸš—',
                'å¨›æ¨‚': 'ğŸ®',
                'è³¼ç‰©': 'ğŸ›ï¸',
                'å…¶ä»–': 'ğŸ“'
            };
            return icons[category] || 'ğŸ’°';
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            notificationMessage.textContent = message;
            
            notification.className = 'fixed top-4 right-4 px-6 py-3 rounded-2xl shadow-lg transition-all duration-300 z-50';
            if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
            } else {
                notification.classList.add('bg-blue-500', 'text-white');
            }
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // ============================================
        // æ¨™ç±¤åˆ‡æ›åŠŸèƒ½
        // ============================================
        window.switchTab = function(tab) {
            const expenseForm = document.getElementById('form-expense');
            const installmentForm = document.getElementById('form-installment');
            const expenseTab = document.getElementById('tab-expense');
            const installmentTab = document.getElementById('tab-installment');

            if (tab === 'expense') {
                // é‡ç½®åˆ†æœŸè¨ˆç•«è¡¨å–®
                document.getElementById('installment-total').value = '';
                document.getElementById('installment-periods').value = '';
                document.getElementById('installment-start').value = '';
                document.getElementById('installment-category').value = 'é¤é£²';
                document.getElementById('installment-description').value = '';
                
                // é¡¯ç¤ºæ—¥å¸¸æ”¯å‡ºè¡¨å–®
                expenseForm.classList.remove('hidden');
                installmentForm.classList.add('hidden');
                expenseTab.classList.add('bg-teal-500', 'text-white');
                expenseTab.classList.remove('bg-gray-100', 'text-gray-600');
                installmentTab.classList.add('bg-gray-100', 'text-gray-600');
                installmentTab.classList.remove('bg-teal-500', 'text-white');
            } else {
                // é‡ç½®æ—¥å¸¸æ”¯å‡ºè¡¨å–®
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('expense-date').value = today;
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-category').value = 'é¤é£²';
                document.getElementById('expense-description').value = '';
                
                // é¡¯ç¤ºåˆ†æœŸè¨ˆç•«è¡¨å–®
                expenseForm.classList.add('hidden');
                installmentForm.classList.remove('hidden');
                installmentTab.classList.add('bg-teal-500', 'text-white');
                installmentTab.classList.remove('bg-gray-100', 'text-gray-600');
                expenseTab.classList.add('bg-gray-100', 'text-gray-600');
                expenseTab.classList.remove('bg-teal-500', 'text-white');
            }
        };

        // ============================================
        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        // ============================================
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>

