<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>休閒風個人記帳本</title>
    
    <!-- Tailwind CSS CDN -->
<script>
  window.__app_id = 'my-finance-app';
  window.__firebase_config = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  // 可選：使用 Custom Token
  // window.__initial_auth_token = "your-custom-token";
</script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, setDoc, doc, onSnapshot, query, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ============================================
        // 全域變數與配置
        // ============================================
        const __app_id = window.__app_id || 'default-app';
        const __firebase_config = window.__firebase_config || {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const __initial_auth_token = window.__initial_auth_token || null;

        // 初始化 Firebase
        const app = initializeApp(__firebase_config);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userBasePath = null;

        // ============================================
        // 認證流程
        // ============================================
        async function authenticateUser() {
            try {
                if (__initial_auth_token) {
                    // 使用 Custom Token 登入
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log('✓ 使用 Custom Token 登入成功');
                } else {
                    // 匿名登入
                    await signInAnonymously(auth);
                    console.log('✓ 匿名登入成功');
                }
            } catch (error) {
                console.error('認證失敗:', error);
                showNotification('認證失敗，請重新整理頁面', 'error');
            }
        }

        // 監聽認證狀態
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userBasePath = `artifacts/${__app_id}/users/${user.uid}`;
                console.log('✓ 用戶已登入:', user.uid);
                initializeAppData();
            } else {
                console.log('⚠ 用戶未登入，嘗試認證...');
                authenticateUser();
            }
        });

        // ============================================
        // 應用程式初始化
        // ============================================
        function initializeAppData() {
            // 載入總資產
            loadTotalAssets();
            
            // 載入月度總覽與交易清單
            updateMonthlySummaryAndList();
            
            // 顯示主要內容
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        }

        // ============================================
        // 總資產管理
        // ============================================
        function loadTotalAssets() {
            const assetsRef = doc(db, `${userBasePath}/assets/main`);
            
            onSnapshot(assetsRef, (docSnap) => {
                const totalAssets = docSnap.exists() ? Number(docSnap.data().totalAssets || 0) : 0;
                document.getElementById('total-assets').textContent = formatCurrency(totalAssets);
            }, (error) => {
                console.error('載入總資產失敗:', error);
            });
        }

        async function updateTotalAssets() {
            const input = document.getElementById('assets-input');
            const newAssets = Number(input.value);

            if (isNaN(newAssets) || newAssets < 0) {
                showNotification('請輸入有效的金額', 'error');
                return;
            }

            try {
                const assetsRef = doc(db, `${userBasePath}/assets/main`);
                await setDoc(assetsRef, {
                    totalAssets: newAssets,
                    lastUpdated: Timestamp.now()
                });
                
                showNotification('總資產已更新', 'success');
                input.value = '';
            } catch (error) {
                console.error('更新總資產失敗:', error);
                showNotification('更新失敗，請稍後再試', 'error');
            }
        }

        // ============================================
        // 日常支出記錄
        // ============================================
        async function addExpense() {
            const date = document.getElementById('expense-date').value;
            const amount = Number(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value;

            // 驗證輸入
            if (!date || isNaN(amount) || amount <= 0 || !category) {
                showNotification('請填寫所有必填欄位', 'error');
                return;
            }

            try {
                const expensesRef = collection(db, `${userBasePath}/expenses`);
                await addDoc(expensesRef, {
                    date: date,
                    amount: amount,
                    category: category,
                    description: description || '',
                    timestamp: Timestamp.now()
                });

                showNotification('支出已記錄', 'success');
                
                // 清空表單
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-category').value = '餐飲';
                document.getElementById('expense-description').value = '';
            } catch (error) {
                console.error('新增支出失敗:', error);
                showNotification('新增失敗，請稍後再試', 'error');
            }
        }

        // ============================================
        // 信用卡分期追蹤（關鍵功能）
        // ============================================
        async function addInstallment() {
            const totalAmount = Number(document.getElementById('installment-total').value);
            const periods = Number(document.getElementById('installment-periods').value);
            const startMonth = document.getElementById('installment-start').value;
            const category = document.getElementById('installment-category').value;
            const description = document.getElementById('installment-description').value;

            // 嚴格驗證輸入
            if (isNaN(totalAmount) || totalAmount <= 0) {
                showNotification('請輸入有效的總額', 'error');
                return;
            }
            if (isNaN(periods) || periods <= 0 || !Number.isInteger(periods)) {
                showNotification('請輸入有效的期數（正整數）', 'error');
                return;
            }
            if (!startMonth || !category) {
                showNotification('請填寫所有必填欄位', 'error');
                return;
            }

            // 計算每月攤還金額
            const monthlyPayment = totalAmount / periods;

            try {
                const installmentsRef = collection(db, `${userBasePath}/installments`);
                await addDoc(installmentsRef, {
                    totalAmount: totalAmount,
                    periods: periods,
                    startMonth: startMonth,
                    category: category,
                    description: description || '',
                    monthlyPayment: monthlyPayment,
                    timestamp: Timestamp.now()
                });

                showNotification('分期計畫已新增', 'success');
                
                // 清空表單
                document.getElementById('installment-total').value = '';
                document.getElementById('installment-periods').value = '';
                document.getElementById('installment-start').value = '';
                document.getElementById('installment-category').value = '餐飲';
                document.getElementById('installment-description').value = '';
            } catch (error) {
                console.error('新增分期計畫失敗:', error);
                showNotification('新增失敗，請稍後再試', 'error');
            }
        }

        // ============================================
        // 月度總覽與交易清單（即時更新）
        // ============================================
        function updateMonthlySummaryAndList() {
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            
            let monthlyExpenses = 0;
            let monthlyInstallments = 0;
            const transactionList = [];

            // 監聽日常支出
            const expensesRef = collection(db, `${userBasePath}/expenses`);
            const expensesQuery = query(expensesRef, orderBy('timestamp', 'desc'));
            
            onSnapshot(expensesQuery, (snapshot) => {
                monthlyExpenses = 0;
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const expenseMonth = data.date.slice(0, 7);
                    const amount = Number(data.amount || 0);
                    
                    if (expenseMonth === currentMonth) {
                        monthlyExpenses += amount;
                    }
                    
                    // 添加到交易清單（最近30筆）
                    transactionList.push({
                        id: doc.id,
                        type: 'expense',
                        date: data.date,
                        amount: amount,
                        category: data.category,
                        description: data.description,
                        timestamp: data.timestamp
                    });
                });
                
                updateDashboard();
            });

            // 監聽分期計畫（關鍵：確保數字類型轉換）
            const installmentsRef = collection(db, `${userBasePath}/installments`);
            const installmentsQuery = query(installmentsRef, orderBy('timestamp', 'desc'));
            
            onSnapshot(installmentsQuery, (snapshot) => {
                monthlyInstallments = 0;
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // 強制轉換為數字類型（防止計算錯誤）
                    const totalAmount = Number(data.totalAmount || 0);
                    const periods = Number(data.periods || 1);
                    const startMonth = data.startMonth;
                    const monthlyPayment = Number(data.monthlyPayment || (totalAmount / periods));
                    
                    // 檢查當前月份是否在分期支付範圍內
                    if (isMonthInInstallmentRange(currentMonth, startMonth, periods)) {
                        monthlyInstallments += monthlyPayment;
                        
                        // 添加到交易清單
                        transactionList.push({
                            id: doc.id,
                            type: 'installment',
                            date: currentMonth + '-01',
                            amount: monthlyPayment,
                            category: data.category,
                            description: `${data.description} (分期 ${periods} 期)`,
                            timestamp: data.timestamp,
                            installmentInfo: {
                                totalAmount: totalAmount,
                                periods: periods,
                                startMonth: startMonth
                            }
                        });
                    }
                });
                
                updateDashboard();
            });

            // 更新儀表板顯示
            function updateDashboard() {
                document.getElementById('monthly-expenses').textContent = formatCurrency(monthlyExpenses);
                document.getElementById('monthly-installments').textContent = formatCurrency(monthlyInstallments);
                document.getElementById('monthly-total').textContent = formatCurrency(monthlyExpenses + monthlyInstallments);
                
                // 渲染交易清單
                renderTransactionList(transactionList);
            }
        }

        // 檢查月份是否在分期範圍內
        function isMonthInInstallmentRange(currentMonth, startMonth, periods) {
            const current = new Date(currentMonth + '-01');
            const start = new Date(startMonth + '-01');
            const end = new Date(start);
            end.setMonth(end.getMonth() + periods);
            
            return current >= start && current < end;
        }

        // 渲染交易清單
        function renderTransactionList(transactions) {
            const listContainer = document.getElementById('transaction-list');
            
            // 排序交易（按時間戳降序）
            const sortedTransactions = transactions
                .sort((a, b) => {
                    const timeA = a.timestamp?.toMillis() || 0;
                    const timeB = b.timestamp?.toMillis() || 0;
                    return timeB - timeA;
                })
                .slice(0, 30); // 只顯示最近30筆

            if (sortedTransactions.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <p>尚無交易紀錄</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = sortedTransactions.map(tx => {
                const categoryIcon = getCategoryIcon(tx.category);
                const typeLabel = tx.type === 'installment' ? '分期' : '支出';
                const typeBadgeColor = tx.type === 'installment' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                
                return `
                    <div class="bg-white rounded-2xl p-4 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-2xl">${categoryIcon}</span>
                                    <span class="text-sm font-medium text-gray-600">${tx.category}</span>
                                    <span class="text-xs px-2 py-1 rounded-full ${typeBadgeColor}">${typeLabel}</span>
                                </div>
                                <p class="text-gray-700 font-medium">${tx.description || '無描述'}</p>
                                <p class="text-xs text-gray-400 mt-1">${tx.date}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-red-500">-${formatCurrency(tx.amount)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // 工具函數
        // ============================================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function getCategoryIcon(category) {
            const icons = {
                '餐飲': '🍽️',
                '交通': '🚗',
                '娛樂': '🎮',
                '購物': '🛍️',
                '其他': '📝'
            };
            return icons[category] || '💰';
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            notificationMessage.textContent = message;
            
            // 設置顏色
            notification.className = 'fixed top-4 right-4 px-6 py-3 rounded-2xl shadow-lg transition-all duration-300 z-50';
            if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
            } else {
                notification.classList.add('bg-blue-500', 'text-white');
            }
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // ============================================
        // 綁定全域函數到 window
        // ============================================
        window.updateTotalAssets = updateTotalAssets;
        window.addExpense = addExpense;
        window.addInstallment = addInstallment;

        // 設置默認日期
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const expenseDateInput = document.getElementById('expense-date');
            if (expenseDateInput) {
                expenseDateInput.value = today;
            }
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 50%, #80cbc4 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #78a1a1 0%, #5a8585 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(120, 161, 161, 0.4);
        }

        .input-field {
            transition: all 0.3s ease;
        }

        .input-field:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(120, 161, 161, 0.2);
        }

        .scroll-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #78a1a1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #5a8585;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- 通知組件 -->
    <div id="notification" class="hidden fixed top-4 right-4 px-6 py-3 rounded-2xl shadow-lg z-50">
        <p id="notification-message" class="font-medium"></p>
    </div>

    <!-- 載入中狀態 -->
    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-teal-600 mb-4"></div>
            <p class="text-teal-700 font-medium text-lg">載入中...</p>
        </div>
    </div>

    <!-- 主要內容 -->
    <div id="main-content" class="hidden max-w-7xl mx-auto">
        <!-- 標題 -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-teal-800 mb-2">💰 休閒風個人記帳本</h1>
            <p class="text-teal-600">輕鬆管理您的財務，追蹤每一筆支出</p>
        </header>

        <!-- 響應式佈局 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左側：資產總覽與月度總覽 -->
            <div class="lg:col-span-1 space-y-6">
                <!-- 總資產卡片 -->
                <div class="glass-card rounded-3xl p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>💎</span>
                        <span>總資產</span>
                    </h2>
                    <div class="text-center mb-6">
                        <p class="text-4xl font-bold text-teal-700" id="total-assets">$0</p>
                    </div>
                    <div class="space-y-3">
                        <input 
                            type="number" 
                            id="assets-input" 
                            placeholder="輸入新的總資產"
                            class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                        >
                        <button 
                            onclick="updateTotalAssets()"
                            class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                        >
                            更新總資產
                        </button>
                    </div>
                </div>

                <!-- 本月支出預覽 -->
                <div class="glass-card rounded-3xl p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>📊</span>
                        <span>本月支出預覽</span>
                    </h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">一般支出</span>
                            <span class="font-bold text-red-500" id="monthly-expenses">$0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">分期攤提</span>
                            <span class="font-bold text-purple-500" id="monthly-installments">$0</span>
                        </div>
                        <div class="border-t-2 border-teal-200 pt-3 flex justify-between items-center">
                            <span class="text-lg font-bold text-teal-800">本月總計</span>
                            <span class="text-2xl font-bold text-teal-700" id="monthly-total">$0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 中間：操作區 -->
            <div class="lg:col-span-1 space-y-6">
                <!-- 新增日常支出 -->
                <div class="glass-card rounded-3xl p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>📝</span>
                        <span>新增日常支出</span>
                    </h2>
                    <form class="space-y-4" onsubmit="event.preventDefault(); addExpense();">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">日期</label>
                            <input 
                                type="date" 
                                id="expense-date" 
                                required
                                class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">金額</label>
                            <input 
                                type="number" 
                                id="expense-amount" 
                                placeholder="輸入金額"
                                required
                                min="0"
                                step="1"
                                class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">類別</label>
                            <select 
                                id="expense-category"
                                required
                                class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            >
                                <option value="餐飲">🍽️ 餐飲</option>
                                <option value="交通">🚗 交通</option>
                                <option value="娛樂">🎮 娛樂</option>
                                <option value="購物">🛍️ 購物</option>
                                <option value="其他">📝 其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">描述</label>
                            <input 
                                type="text" 
                                id="expense-description" 
                                placeholder="項目描述（選填）"
                                class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            >
                        </div>
                        <button 
                            type="submit"
                            class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                        >
                            新增支出
                        </button>
                    </form>
                </div>

                <!-- 新增分期計畫 -->
                <div class="glass-card rounded-3xl p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>💳</span>
                        <span>新增分期計畫</span>
                    </h2>
                    <form class="space-y-4" onsubmit="event.preventDefault(); addInstallment();">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">總額</label>
                            <input 
                                type="number" 
                                id="installment-total" 
                                placeholder="輸入總金額"
                                required
                                min="0"
                                step="1"
                                class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">期數</label>
                            <input 
                                type="number" 
                                id="installment-periods" 
                                placeholder="分幾期"
                                required
                                min="1"
                                step="1"
                                class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">開始月份</label>
                            <input 
                                type="month" 
                                id="installment-start" 
                                required
                                class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">類別</label>
                            <select 
                                id="installment-category"
                                required
                                class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            >
                                <option value="餐飲">🍽️ 餐飲</option>
                                <option value="交通">🚗 交通</option>
                                <option value="娛樂">🎮 娛樂</option>
                                <option value="購物">🛍️ 購物</option>
                                <option value="其他">📝 其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">描述</label>
                            <input 
                                type="text" 
                                id="installment-description" 
                                placeholder="項目描述（選填）"
                                class="input-field w-full px-4 py-3 rounded-2xl border-2 border-teal-200 focus:border-teal-400 focus:outline-none"
                            >
                        </div>
                        <button 
                            type="submit"
                            class="btn-primary w-full py-3 rounded-2xl text-white font-medium"
                        >
                            新增分期計畫
                        </button>
                    </form>
                </div>
            </div>

            <!-- 右側：交易紀錄 -->
            <div class="lg:col-span-1">
                <div class="glass-card rounded-3xl p-6 shadow-xl">
                    <h2 class="text-xl font-bold text-teal-800 mb-4 flex items-center gap-2">
                        <span>📜</span>
                        <span>近期交易紀錄</span>
                    </h2>
                    <div id="transaction-list" class="scroll-container space-y-3">
                        <!-- 交易紀錄將動態載入 -->
                        <div class="text-center text-gray-400 py-8">
                            <p>載入中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 頁尾 -->
        <footer class="text-center mt-12 text-teal-600">
            <p class="text-sm">© 2025 休閒風個人記帳本 | 輕鬆管理，精彩生活 ✨</p>
        </footer>
    </div>
</body>
</html>
